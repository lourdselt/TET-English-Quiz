<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>test-02</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
function getQuizName(){
  try{
    let tn = (document.title || "").trim();
    if(!tn){ tn = (location.pathname.split('/').pop() || '').replace(/\.[^.]+$/, ''); }
    tn = tn || 'test-02';
    // Return the title/filename as the sheet tab name (no legacy mapping)
    return tn;
  }catch(e){ return 'Test2'; }
}
function sendToGoogleSheet() {
  if(!window.candidateInfo){ console.warn('No candidateInfo; skipping sheet send'); return; }
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const elapsedSec = 1800 - timeLeft;
  const timeReadable = `${String(Math.floor(elapsedSec/60)).padStart(2,'0')}:${String(elapsedSec%60).padStart(2,'0')}`;
  const timeTaken = timeReadable;
  const answers = selectedAnswers.map((idx) => idx===null?"":['A','B','C','D'][idx]);
  const answersCsv = answers.join(',');
  const answerTexts = selectedAnswers.map((idx,i)=> (idx!==null && questions[i] && questions[i].options[idx])? questions[i].options[idx] : "");
  console.log('Selected indices:', JSON.stringify(selectedAnswers));
  console.log('Answer codes to send:', JSON.stringify(answers));
  const payload = { quizName: getQuizName(), name, email, phone, subject, attempted, unattempted, score, timeTaken, timeTakenReadable: timeReadable, answers, answerCodes: answers, answersCsv, answerCodesCsv: answersCsv, answerTexts };
  fetch("https://script.google.com/macros/s/AKfycbyeVJR0A_CvLsIXQvx5IN7zcPK66T0Uy3B09kasOSgXnxGp8LaepjmIt-IXwA3d0rHiUw/exec", {
    method: "POST", body: JSON.stringify(payload), mode: "no-cors"
  }).then(() => console.log("Sheet submission sent")).catch(err => console.error("Error sending to sheet:", err));
}
</script>
<style>
  em { font-family: 'Roboto', Arial, sans-serif; font-style: italic; font-weight: bold; font-size: 1.05em; color: #2a2a2a; }
  .blank { display: inline-block; border-bottom: 1px solid #333; min-width: 60px; height: 1.2em; vertical-align: middle; margin: 0 4px; }
  body, #quiz, #question-area, .option-div, .timer { font-family: 'Roboto', Arial, sans-serif; background:#f0f2f5; }
  #question-grid button { width: 30px; height: 30px; margin: 2px; color: white; font-weight: bold; border-radius: 4px; border: none; font-size: 12px; }
  .unanswered { background-color: #dc3545; }
  .answered { background-color: #28a745; }
  .marked { background-color: #6f42c1; }
  .passage-container { max-height: 220px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ced4da; margin-bottom: 15px; }
  .timer { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
  .correct { color: green; font-weight: bold; }
  .wrong { color: red; font-weight: bold; }
  .progress { height: 20px; margin-bottom: 15px; }
  .option-div { margin: 0 0 0 8px; padding: 0; line-height: 1.2; display: flex; align-items: center; }
  .option-div label { display: inline; margin-left: 6px; }
  .site-header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #fff; border-bottom: 1px solid #e6e6e6; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 1100; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
  .site-header .brand { font-weight: 700; font-size: 1.05rem; color: #222; }
  .site-header .testname { font-size: 0.95rem; color: #555; }
  body { padding-top: 72px; }
  /* Result card watermark sizing and placement */
  #result .card { position: relative; overflow: hidden; }
  .logo-watermark { position: absolute; right: 12px; top: 12px; width: 80px; height: auto; opacity: 0.12; pointer-events: none; filter: grayscale(100%); }
  /* Align question number on the left and all question lines in a straight left line */
  .qrow { display: flex; align-items: flex-start; gap: 10px; }
  .qnum { flex: 0 0 40px; min-width: 40px; text-align: left; font-weight: 700; }
  .qtext { flex: 1 1 auto; }
  .qtext .qtitle { font-weight: 700; margin-bottom: 4px; }
  .qtext .qstem { margin-bottom: 8px; }
  .qtext .option-div { margin-left: 0; }
</style>
</head>
<body>
<header class="site-header" role="banner" aria-label="Site header">
  <div class="brand">LOURDS ENGLISH ACADEMY</div>
  <div id="test-name" class="testname"></div>
</header>

<div class="container my-4">
  <div id="login" class="card p-4 shadow">
    <h3 class="mb-3">Enter Candidate Details</h3>
    <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" required>
    <input type="tel" id="phone" class="form-control mb-2" placeholder="Phone Number" required>
    <select id="subject" class="form-select mb-2" required onchange="onSubjectChange()">
      <option value="">Select Subject</option>
      <option>Tamil</option><option>English</option><option>Maths</option><option>Physics</option>
      <option>Chemistry</option><option>Botony</option><option>Zoology</option><option>History</option><option>Geography</option>
      <option value="Other">Other</option>
    </select>
    <input type="text" id="subject-other" class="form-control mb-2" placeholder="Enter subject (if Other)" style="display:none;" />
    <button class="btn btn-primary mt-2" onclick="startQuiz()">Start Quiz</button>
  </div>
  
</div>

<div id="quiz" class="container-fluid" style="display:none;">
  <div class="row">
    <div class="col-md-2 bg-white p-3 shadow">
      <h5 class="text-center mb-3">Questions</h5>
      <div id="question-grid" class="d-flex flex-wrap justify-content-center"></div>
      <div class="mt-3 text-center">
        <span class="fw-bold">Green:</span> Answered<br>
        <span class="fw-bold">Red:</span> Unanswered<br>
        <span class="fw-bold">Purple:</span> Marked
      </div>
    </div>
    <div class="col-md-10 p-4">
      <div class="timer text-end" id="timer">Time Remaining: 30:00</div>
      <div class="progress mb-3">
        <div id="timerBar" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
      </div>
      <div id="passage-section" class="passage-container" style="display:none;">
        <h5>Read the passage carefully:</h5>
        <p>Most of us use the products of science &mdash; railways, aeroplanes, electricity, phones and thousands of others &mdash; without thinking how they came into existence. We take them for granted, as if we are entitled to them as a matter of right. And we are very proud of the fact that we live in an advanced age and are ourselves so very advanced.</p>
        <p>There is no doubt that our age is a very different one from previous ages and I think it is perfectly correct to say that it is far more advanced. But that is a different thing from saying that we as individuals or groups are more advanced. It would be the height of absurdity to say that because an engine driver can run an engine and Plato or Socrates could not, the engine driver is more advanced than, or is superior to Plato or Socrates. But it would be perfectly correct to say that the engine itself is a more advanced method of locomotion than Plato’s chariot was.</p>
      </div>
      <div class="card p-3 mb-3 shadow" id="question-area"></div>
      <div class="mb-4">
        <button class="btn btn-secondary me-2" onclick="prevQuestion()">Previous</button>
        <button class="btn btn-secondary me-2" onclick="nextQuestion()">Next</button>
        <button class="btn btn-warning me-2" onclick="markForReview()">Mark for Review</button>
        <button class="btn btn-success" onclick="submitQuiz()">Submit Test</button>
      </div>
    </div>
  </div>
</div>

<div id="result" class="container my-4" style="display:none;">
  <div class="card p-4 shadow">
    <img id="logo-watermark" class="logo-watermark" alt="watermark logo" style="display:none;">
    <h3 class="mb-3">Quiz Result</h3>
    <p id="candidate-details"></p>
    <p>Total Questions: 30</p>
    <p>Attempted: <span id="attempted"></span></p>
    <p>Unattempted: <span id="unattempted"></span></p>
    <p>Score: <span id="score"></span> / 30</p>
    <p>Time Taken: <span id="time-taken"></span></p>
    <div id="answer-review" class="mt-3"></div>
    <button class="btn btn-info mt-3" onclick="downloadPDF()">Download Result as PDF</button>
  </div>
</div>

<script>
let currentQuestion = 0;
// Store selected answers as option INDEX (0-3)
let selectedAnswers = Array(30).fill(null);
let markedQuestions = Array(30).fill(false);
let timerInterval;
let timeLeft = 1800;

const questions = [
  {q:"Pick out the adjective which can best fill in the blank:", stem:"The <span class='blank'></span> chapters are lacking in interest.", options:["later","latest","latter","letter"]},
  {q:"Which is the most appropriate passive form of the sentence?", stem:"“One should keep one’s promises”", options:["We should keep our promises","Promises should be kept","Promises need not be kept","Promises may be kept"]},
  {q:"The most appropriate conversion to a simple sentence from: ", stem:"“We must eat, or we cannot live” is —", options:["We must live to eat","We must not live to eat","We must eat and live","We must eat to live"]},
  {q:"In which classification of work can we categorise teaching?", stem:"", options:["Clerical","Managerial","Skilled","Professional"]},
  {q:"Choose the most appropriate complementary closing for a letter addressed to Sub-Inspector of Police:", stem:"", options:["Yours lovingly","Lovingly yours","Yours truly","Yours affectionately"]},
  {q:"Sequence the sentences properly:", stem:`<div>In the following question the passage of six sentences. The first and last sentences are given in the beginning. The middle four sentences are jumbled up as P,Q R and S. sequence the sentences properly choosing the right option.</div>
<div style="font-weight:bold;">S1 – There was no limit to insanitation</div>
<div style="font-weight:bold;">S6 – So I asked for a broom to clean them myself</div>
<div>P – There were only a few latrines</div>
<div>Q – They refused point-blank to clean them</div>
<div>R – Pools of water were everywhere</div>
<div>S – I pointed it out to the volunteers</div>
<b>Proper sequence is —</b>`, options:["RSPQ","QPSR","RPSQ","QSPR"]},
  {q:"Find the italicized part in the sentence that is incorrect:", stem:`Things <b><em>will be</em> (1)</b> better if I <b><em>will get</em> (2)</b> a job and <b><em>earn</em> (3)</b> some money. Then I <b><em>won’t have</em> (4)</b> to live with my parents.`, options:["1","2","3","4"]},
  {q:"Find the italicized part in the sentence that is incorrect:", stem:`The <b><em>company claimed</em> (1)</b> to bring the best <b><em>products and services</em> (2)</b> <b><em>on the doorstep</em> (3)</b> <b><em>of their consumers</em> (4)</b>.`, options:["1","2","3","4"]},
  {q:"Identify the errors:", stem:"It is raining. Mohan and Sumesh were walking on the park. The path is wet. Mohan slips and fell.", options:["raining, were, on","were, on, fell","were, on, slips","were, slips, fell"]},
  {q:"Choose the most appropriate clause that can replace the adjective phrase in the sentence:", stem:"Madhu met a girl with blue eyes.", options:["Whose eyes are blue","Whose eyes were blue","Those eyes were blue","Those eyes are blue"]},
  {q:"In the sentence “The train came rushing down the hill”, the word ‘down’ functions as —", stem:"", options:["Noun","Preposition","Verb","Adverb"]},
  {q:"Fill in the blank:", stem:"Smt. Sheela became <span class='blank'></span> Principal of the College in 2005.", options:["a","the","an","no article"]},
  {q:"Pick the odd one:", stem:"Pretty, attractive, beautiful, smart, lively", options:["Attractive","Lively","Beautiful","Pretty"]},
  {q:"Which of the following is not an instruction?", stem:"", options:["What an idea","Sit down","Be silent","Queue up"]},
  {q:"Read the passage and answer:", stem:"Which one of the following statements is correct?", options:["An engine driver cannot be compared to Plato or Socrates","Plato or Socrates is in no way inferior to the engine driver","Plato or Socrates surpassed the engine driver in every respect","An engine driver is cleverer than Plato or Socrates"]},
  {q:"Read the passage and answer:", stem:"People today are very proud because they —", options:["live in a philosophically advanced age","live in a spiritually advanced age","enjoy digital communications","live in a scientifically advanced age"]},
  {q:"Read the passage and answer:", stem:"Many of us make use of machines —", options:["with full knowledge of their genesis","without knowing how they were invented","with very little knowledge of their mechanism","without any knowledge of their historical significance"]},
  {q:"Read the passage and answer:", stem:"Plato and Socrates are mentioned to emphasize that —", options:["They had a great respect for learning","They were men of great scholarship","People as individuals today are not more advanced than their predecessors","The engine is a better mode of locomotion"]},
  {q:"Read the passage and answer:", stem:"The phrase ‘height of absurdity’ implies —", options:["The possible extent of rationality","The impossible extent of rationality","The possible extent of irrationality","The impossible extent of rationality"]},
  {q:"If a medal is an award made of gold, silver or bronze, choose the homophone:", stem:"", options:["Meddle","Muddle","Middle","Medel"]},
  {q:"Verbal guidance is least effective in the learning of —", stem:"", options:["Attitudes","Relationships","Skills","Facts"]},
  {q:"My landlady was very _____ when I met with an accident.", stem:"", options:["merciful","pitiful","sympathetic","hearty"]},
  {q:"The receptionist _____ to ring another hotel.", stem:"", options:["offered","suggested","recommended","invited"]},
  {q:"I assure you I have no wish to _______ my responsibility.", stem:"", options:["shirk","refuse","abandon","disobey"]},
  {q:"Has there been any _______ on the strike from the Government?", stem:"", options:["reaction","response","comment","criticism"]},
  {q:"The boy backed up his friend’s claim. The idiom means —", stem:"", options:["accepted","supported","explained","denied"]},
  {q:"Choose the appropriate tag:", stem:"Have some rice, <span class='blank'></span>?", options:["will you","shall you","may you","won’t you"]},
  {q:"Fill the blanks:", stem:"I met a boy <span class='blank'></span> told me <span class='blank'></span> I could find you.", options:["who, were","that, were","that, where","who, where"]},
  {q:"Dr. A.P.J. Abdul Kalam has consented to address students. Which discourse is best for informing parents?", stem:"", options:["Letter","Diary","Notice","Slogan"]},
  {q:"How many syllables are there in the word ‘examination’?", stem:"", options:["4","3","5","6"]}
];
const correctAnswers = [
  "latter",
  "Promises should be kept",
  "We must eat to live",
  "Professional",
  "Yours truly",
  "RPSQ",
  "2",
  "4",
  "were, on, fell",
  "Whose eyes were blue",
  "Adverb",
  "the",
  "Lively",
  "What an idea",
  "Plato or Socrates is in no way inferior to the engine driver",
  "live in a scientifically advanced age",
  "without knowing how they were invented",
  "The engine is a better mode of locomotion",
  "The possible extent of irrationality",
  "Meddle",
  "Skills",
  "sympathetic",
  "offered",
  "shirk",
  "response",
  "supported",
  "will you",
  "who, where",
  "Notice",
  "5"
];

function startQuiz(){
  let name = document.getElementById('name').value.trim();
  let email = document.getElementById('email').value.trim();
  let phone = document.getElementById('phone').value.trim();
  let subject = document.getElementById('subject').value;
  if (subject === 'Other') {
    const otherVal = (document.getElementById('subject-other').value || '').trim();
    if (!otherVal) { alert('Please type your subject'); return; }
    subject = otherVal;
  }
  if(!name || !email || !phone || !subject){ alert("Please fill all details"); return;}
  window.candidateInfo = {name,email,phone,subject};
  document.getElementById('login').style.display='none';
  document.getElementById('quiz').style.display='block';
  buildQuestionGrid();
  showQuestion(currentQuestion);
  startTimer();
}

function onSubjectChange(){
  const sel = document.getElementById('subject');
  const other = document.getElementById('subject-other');
  if (!sel || !other) return;
  if (sel.value === 'Other') { other.style.display = ''; other.focus(); }
  else { other.style.display = 'none'; other.value = ''; }
}

function buildQuestionGrid(){
  let grid = document.getElementById('question-grid');
  for(let i=0;i<30;i++){
    let btn = document.createElement('button');
    btn.id = 'qbtn'+i;
    btn.innerText = i+1;
    btn.className = 'unanswered';
    btn.onclick = ()=>{currentQuestion=i; showQuestion(i);} 
    grid.appendChild(btn);
  }
}

function showQuestion(index){
  // Show passage for questions 15-19 (index 14..18)
  if (index >= 14 && index <= 18) {
    document.getElementById('passage-section').style.display = 'block';
  } else {
    document.getElementById('passage-section').style.display = 'none';
  }
  let q = questions[index];
  let html = `<div><b>Q${index+1}. ${q.q}</b></div>`;
  html += `<div>${q.stem || ''}</div>`;
  const optionCodes = ['a)', 'b)', 'c)', 'd)'];
  for(let i=0;i<q.options.length;i++){
    const checked = selectedAnswers[index] === i ? 'checked' : '';
    html += `<div class="option-div"><input type="radio" name="option" id="opt${i}" value="${i}" ${checked} onclick="selectOptionIndex(${i})"> <label for="opt${i}">${optionCodes[i]} ${q.options[i]}</label></div>`;
  }
  document.getElementById('question-area').innerHTML = html;
}

function selectOptionIndex(idx){ selectedAnswers[currentQuestion] = idx; updateGridStatus(); }
function updateGridStatus(){
  for(let i=0;i<30;i++){
    let btn = document.getElementById('qbtn'+i);
    if(markedQuestions[i]) btn.className='marked';
    else if(selectedAnswers[i] !== null) btn.className='answered';
    else btn.className='unanswered';
  }
}
function nextQuestion(){ if(currentQuestion<29){ currentQuestion++; showQuestion(currentQuestion);} }
function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; showQuestion(currentQuestion);} }
function markForReview(){ markedQuestions[currentQuestion]=true; updateGridStatus(); }
function startTimer(){ timerInterval = setInterval(()=>{ timeLeft--; let min=Math.floor(timeLeft/60); let sec=timeLeft%60; document.getElementById('timer').innerText=`Time Remaining: ${String(min).padStart(2,'0')}:${sec<10?'0'+sec:sec}`; document.getElementById('timerBar').style.width=(timeLeft/1800*100)+'%'; if(timeLeft<=0){ clearInterval(timerInterval); submitQuiz();}},1000); }
function submitQuiz(){ clearInterval(timerInterval); document.getElementById('quiz').style.display='none'; document.getElementById('result').style.display='block'; showResult(); sendToGoogleSheet(); }

function showResult(){
  let {name,email,phone,subject} = window.candidateInfo;
  document.getElementById('candidate-details').innerHTML=`Name: ${name} | Email: ${email} | Phone: ${phone} | Subject: ${subject}`;
  let attempted=selectedAnswers.filter(a=>a!==null).length;
  document.getElementById('attempted').innerText=attempted;
  document.getElementById('unattempted').innerText=30-attempted;
  let score=0;
  let html="";
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userIdx=selectedAnswers[i];
    const norm = (s)=> (""+s).replace(/\s+/g,' ').trim();
    let correctIdx = Array.isArray(q.options) ? q.options.findIndex(o => norm(o)===norm(correctAnswers[i])) : -1;
    if(userIdx!==null && userIdx===correctIdx) score++;
    const userText = (userIdx!==null && q.options[userIdx]) ? q.options[userIdx] : 'Not answered';
    const correctText = (correctIdx>=0 && q.options[correctIdx]) ? q.options[correctIdx] : correctAnswers[i];
    const cls = (userIdx!==null && userIdx===correctIdx) ? 'correct' : 'wrong';
    html+=`<p><b>Q${i+1}:</b> ${q.stem}<br> Your answer: <span class="${cls}">${userText}</span> | Correct: ${correctText}</p>`;
  }
  document.getElementById('score').innerText=score;
  const elapsedSec = 1800 - timeLeft;
  const mm = Math.floor(elapsedSec/60);
  const ss = elapsedSec % 60;
  const timeReadable = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  document.getElementById('time-taken').innerText = timeReadable;
  document.getElementById('answer-review').innerHTML=html;
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({format: 'a4', unit: 'mm'});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  // Table geometry to keep summary perfectly aligned with table
  const tableMarginLeft = 10;
  const tableColumnWidths = [12, 85, 85]; // Q#, Your Answer, Correct Answer
  const tableRightX = tableMarginLeft + tableColumnWidths.reduce((a,b)=>a+b,0);
  // Helper: centered big watermark on a page
  const drawCenteredWatermark = () => {
    try {
      const b64 = window.logoBlackBase64 || window.logoGreyBase64 || window.logoBase64;
      if (!b64) return;
      const imgEl = document.getElementById('logo-watermark');
      const iw = (imgEl && imgEl.naturalWidth) ? imgEl.naturalWidth : 1000;
      const ih = (imgEl && imgEl.naturalHeight) ? imgEl.naturalHeight : 1000;
      const aspect = iw/ih;
      const maxW = pageWidth * 0.6;
      const maxH = pageHeight * 0.6;
      let w = maxW; let h = w/aspect;
      if (h > maxH) { h = maxH; w = h*aspect; }
      const x = (pageWidth - w)/2;
      const y = (pageHeight - h)/2;
      if (doc.GState) { doc.setGState(new doc.GState({ opacity: 0.06 })); }
      doc.addImage('data:image/png;base64,' + b64, 'PNG', x, y, w, h);
      if (doc.GState) { doc.setGState(new doc.GState({ opacity: 1 })); }
    } catch (_) {}
  };
  // Header with logo and title
  const academy = "LOURDS ENGLISH ACADEMY";
  try {
    const headerB64 = window.logoBlackBase64 || window.logoGreyBase64 || window.logoBase64;
    if (headerB64) { doc.addImage('data:image/png;base64,' + headerB64, 'PNG', 10, 8, 18, 18); }
  } catch (_) {}
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text(academy, pageWidth/2, 16, {align: "center"});
  doc.setFontSize(12);
  doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});

  // Candidate details box
  doc.setLineWidth(0.2);
  // Draw divider line exactly the width of the table
  doc.line(tableMarginLeft, 26, tableRightX, 26);
  doc.setFontSize(10);
  const metaY = 30;
  const attempted = selectedAnswers.filter(a=>a!==null).length;
  const unattempted = 30 - attempted;
  const scoreText = document.getElementById('score').innerText + ' / 30';
  const elapsedSecPDF = 1800 - timeLeft;
  const timeReadablePDF = `${String(Math.floor(elapsedSecPDF/60)).padStart(2,'0')}:${String(elapsedSecPDF%60).padStart(2,'0')}`;
  const timeText = `${timeReadablePDF}`;
  const cd = window.candidateInfo || {name:'',email:'',phone:'',subject:''};
  const leftX = tableMarginLeft, rightX = tableRightX;
  // Left block
  doc.text(`Name: ${cd.name || ''}`, leftX, metaY);
  doc.text(`Email: ${cd.email || ''}`, leftX, metaY+6);
  doc.text(`Phone: ${cd.phone || ''}`, leftX, metaY+12);
  doc.text(`Subject: ${cd.subject || ''}`, leftX, metaY+18);
  // Right block aligned to right edge of table
  doc.text(`Attempted: ${attempted}`, rightX, metaY, { align: 'right' });
  doc.text(`Unattempted: ${unattempted}`, rightX, metaY+6, { align: 'right' });
  // Score in blue
  doc.setTextColor(0, 102, 204);
  doc.text(`Score: ${scoreText}`, rightX, metaY+12, { align: 'right' });
  doc.setTextColor(0, 0, 0);
  doc.text(`Time: ${timeText}`, rightX, metaY+18, { align: 'right' });

  // Build table rows
  const startY = metaY + 26;
  const norm = (s)=> (""+s).replace(/\s+/g,' ').trim();
  const rows = [];
  const ansColors = []; // text color for 'Your Answer' cell per row
  for (let i = 0; i < 30; i++) {
    const q = questions[i];
    const userIdx = selectedAnswers[i];
    const correctIdx = Array.isArray(q.options) ? q.options.findIndex(o => norm(o) === norm(correctAnswers[i])) : -1;
    const code = ['A','B','C','D'];
    const youCode = (userIdx!==null && userIdx>=0) ? code[userIdx] : '';
    const corrCode = (correctIdx>=0) ? code[correctIdx] : '';
    const youText = (userIdx!==null && q.options[userIdx]) ? q.options[userIdx] : '';
    const corrText = (correctIdx>=0 && q.options[correctIdx]) ? q.options[correctIdx] : correctAnswers[i];
    // Decide color: grey for not answered, green for correct, red for wrong
    let color = [130,130,130];
    if (userIdx !== null) {
      color = (userIdx === correctIdx) ? [0,128,0] : [200,0,0];
    }
    ansColors.push(color);
    rows.push([
      (i+1).toString(),
      youCode ? `${youCode}) ${youText}` : 'Not answered',
      corrCode ? `${corrCode}) ${corrText}` : corrText
    ]);
  }

  // Use autoTable for a clean table layout
  if (doc.autoTable) {
    doc.autoTable({
      head: [['Q#', 'Your Answer', 'Correct Answer']],
      body: rows,
      startY: startY,
      margin: { left: tableMarginLeft, right: 10 },
      theme: 'grid',
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [33, 37, 41], halign: 'center', valign: 'middle', fontStyle: 'bold', textColor: 255 },
      columnStyles: {
        0: { halign: 'center', cellWidth: tableColumnWidths[0] },
        1: { cellWidth: tableColumnWidths[1] },
        2: { cellWidth: tableColumnWidths[2] }
      },
      didParseCell: function(data) {
        if (data.section === 'body' && data.column.index === 1) {
          const idx = data.row.index;
          const col = ansColors[idx] || [0,0,0];
          data.cell.styles.textColor = col;
        }
      },
      didDrawPage: function(data) {
        // Watermark for every page, draw after content with very low opacity
        if (data.pageNumber && data.pageNumber >= 1) {
          drawCenteredWatermark();
        }
        // Footer: timestamp left, page numbers right
        const totalPages = doc.internal.getNumberOfPages();
        const pageStr = 'Page ' + totalPages;
        const now = new Date();
        const ts = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        doc.setFontSize(9);
        doc.text(ts, 10, pageHeight - 8);
        doc.text(pageStr, pageWidth - 20, pageHeight - 8);
      }
    });
  } else {
    // Fallback simple list if autotable isn't loaded
    let y = startY;
    for (const r of rows) {
      const line = `${r[0]}. Your: ${r[1]} | Correct: ${r[2]}`;
      const lines = doc.splitTextToSize(line, pageWidth - 20);
      if (y + lines.length*6 > pageHeight - 14) { doc.addPage(); y = 14; }
      doc.text(lines, 10, y);
      y += lines.length*6;
    }
  }

  doc.save("Quiz_Result.pdf");
}

// Set test name in header
(function(){ try{ var tn=(document.title||'').trim() || (location.pathname.split('/').pop()||''); tn=tn.replace(/\.[^.]+$/,''); var el=document.getElementById('test-name'); if(el) el.innerText = tn?('- '+tn):''; }catch(e){} })();

// Load watermark image and prepare grayscale/black variants for PDF and on-page rendering
;(function(){
  fetch('lourds_logo_base64.txt').then(r=>r.text()).then(t=>{
    const raw=t.trim(); if(!raw) return;
    window.logoBase64 = raw.replace(/^data:image\/[a-z]+;base64,/,'');
    const img=new Image();
    img.onload=function(){
      try{
        const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
        const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        const src=ctx.getImageData(0,0,w,h); const data=src.data;
        const grayArr=new Uint8ClampedArray(data); const blackArr=new Uint8ClampedArray(data);
        for(let i=0;i<data.length;i+=4){
          const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
          const y=Math.round(0.299*r+0.587*g+0.114*b);
          // grayscale for watermark
          grayArr[i]=y; grayArr[i+1]=y; grayArr[i+2]=y; grayArr[i+3]=a;
          // darkened grayscale for header icon
          const yDark=Math.max(0,Math.min(255,Math.round(y*0.25)));
          blackArr[i]=yDark; blackArr[i+1]=yDark; blackArr[i+2]=yDark; blackArr[i+3]=a;
        }
        const toB64=(arr)=>{ const c=document.createElement('canvas'); c.width=w; c.height=h; const cx=c.getContext('2d'); const id=cx.createImageData(w,h); id.data.set(arr); cx.putImageData(id,0,0); return c.toDataURL('image/png').replace(/^data:image\/png;base64,/, ''); };
        window.logoGreyBase64=toB64(grayArr);
        window.logoBlackBase64=toB64(blackArr);
      }catch(e){}
      const el=document.getElementById('logo-watermark');
      if(el){ el.src='data:image/png;base64,'+(window.logoGreyBase64||window.logoBase64); el.style.display='block'; }
    };
    img.src='data:image/png;base64,'+window.logoBase64;
  }).catch(()=>{});
})();

// Expose functions to window for inline handlers
try {
  window.startQuiz = startQuiz;
  window.prevQuestion = prevQuestion;
  window.nextQuestion = nextQuestion;
  window.markForReview = markForReview;
  window.submitQuiz = submitQuiz;
  window.selectOptionIndex = selectOptionIndex;
  window.downloadPDF = downloadPDF;
  window.onSubjectChange = onSubjectChange;
} catch(_){}
</script>
</body>
</html>
