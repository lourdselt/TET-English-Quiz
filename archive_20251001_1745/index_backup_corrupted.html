<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TET Test 1</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --md-primary: #1976d2;
    --md-primary-dark: #1565c0;
    --md-secondary: #03dac6;
    --md-surface: #ffffff;
    --md-background: #fafafa;
    --md-error: #b00020;
    --md-on-primary: #ffffff;
    --md-on-surface: #000000;
    --md-shadow: 0 2px 4px rgba(0,0,0,0.1);
    --md-shadow-elevated: 0 8px 16px rgba(0,0,0,0.15);
  }
  
  * {
    box-sizing: border-box;
  }
  
  body {
    font-family: 'Roboto', sans-serif;
    background: var(--md-background);
    margin: 0;
    padding-top: 64px;
    line-height: 1.5;
  }
  
  .md-card {
    background: var(--md-surface);
    border-radius: 8px;
    box-shadow: var(--md-shadow);
    transition: box-shadow 0.3s ease;
  }
  
  .md-card:hover {
    box-shadow: var(--md-shadow-elevated);
  }
  
  .md-button {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-weight: 500;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: 'Roboto', sans-serif;
  }
  
  .md-button-primary {
    background: var(--md-primary);
    color: var(--md-on-primary);
  }
  
  .md-button-primary:hover {
    background: var(--md-primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--md-shadow-elevated);
  }
  
  .md-input {
    width: 100%;
    padding: 16px 12px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    background: transparent;
    transition: border-color 0.3s ease;
  }
  
  .md-input:focus {
    outline: none;
    border-color: var(--md-primary);
    box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.2);
  }
  
  .question-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(48px, 1fr));
    gap: 8px;
    margin: 16px 0;
  }
  
  .question-btn {
    width: 48px;
    height: 48px;
    border: none;
    border-radius: 50%;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .question-btn.unanswered {
    background: #f5f5f5;
    color: #666;
    border: 2px solid #ddd;
  }
  
  .question-btn.answered {
    background: #4caf50;
    color: white;
    box-shadow: var(--md-shadow);
  }
  
  .question-btn.marked {
    background: #ff9800;
    color: white;
    box-shadow: var(--md-shadow);
  }
  
  .question-btn:hover {
    transform: scale(1.1);
    box-shadow: var(--md-shadow-elevated);
  }
  
  .timer-card {
    background: linear-gradient(135deg, #ff5722, #ff9800);
    color: white;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
    margin-bottom: 16px;
  }
  
  .option-card {
    background: var(--md-surface);
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 16px;
    margin: 8px 0;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
  }
  
  .option-card:hover {
    background: #f5f5f5;
    border-color: var(--md-primary);
    transform: translateX(4px);
  }
  
  .option-card input[type="radio"] {
    margin-right: 16px;
    transform: scale(1.2);
  }

  /* Header Styles */
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 80px;
    background: linear-gradient(135deg, var(--md-primary), #3f51b5);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 32px;
    z-index: 1000;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
  }
  
  .site-header .brand {
    font-size: 1.8rem;
    font-weight: 700;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 0.5px;
  }
  
  .site-header .testname {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.9);
    font-weight: 500;
  }

  /* Body padding to account for fixed header */
  body {
    padding-top: 100px;
    margin: 0;
  }

  @media (max-width: 768px) {
    body {
      padding-top: 70px;
    }
    
    .site-header {
      height: 60px;
      padding: 0 16px;
    }
    
    .site-header .brand {
      font-size: 1.3rem;
    }
    
    .site-header .testname {
      font-size: 1rem;
    }    .container {
      padding: 8px;
    }
    
    .question-grid {
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
    }
    
    .question-btn {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .md-input {
      font-size: 16px; /* Prevent zoom on iOS */
    }
  }
  
  @media (max-width: 480px) {
    .question-grid {
      grid-template-columns: repeat(5, 1fr);
    }
    
    .question-btn {
      width: 36px;
      height: 36px;
      font-size: 12px;
    }
    
    .md-card {
      padding: 16px;
    }
  }
</style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="brand">LOURDS ENGLISH ACADEMY</div>
    <div id="test-name" class="testname"></div>
  </header>

<div class="container my-4">
  <div class="md-card p-4">
    <h3 class="mb-4 text-center">Enter Candidate Details</h3>
    <div class="mb-3">
      <input type="text" id="name" class="md-input" placeholder="Full Name" required>
    </div>
    <div class="mb-3">
      <input type="email" id="email" class="md-input" placeholder="Email Address" required>
    </div>
    <div class="mb-3">
      <input type="tel" id="phone" class="md-input" placeholder="Phone Number" required>
    </div>
    <div class="mb-3">
      <select id="subject" class="md-input" required onchange="toggleCustomSubject()">
        <option value="">Select Subject</option>
        <option>Tamil</option><option>English</option><option>Maths</option><option>Physics</option>
        <option>Chemistry</option><option>Botany</option><option>Zoology</option><option>History</option><option>Geography</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="mb-3" id="custom-subject-div" style="display:none;">
      <input type="text" id="custom-subject" class="md-input" placeholder="Enter your subject" maxlength="50">
    </div>
    <button class="md-button md-button-primary w-100" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<div id="quiz" class="container-fluid" style="display:none;">
  <div class="row">
    <div class="col-md-3 p-3">
      <div class="md-card p-3">
        <h6 class="text-center mb-3">Questions</h6>
        <div id="question-grid" class="question-grid"></div>
        <div class="mt-3">
          <div class="text-center mb-2">
            <div class="d-flex justify-content-between">
              <span>Answered: <strong id="answered-count">0</strong></span>
              <span>Remaining: <strong id="unanswered-count">30</strong></span>
            </div>
          </div>
          <div class="text-center small">
            <div class="mb-1"><span class="badge" style="background:#4caf50">●</span> Answered</div>
            <div class="mb-1"><span class="badge" style="background:#f5f5f5;color:#666">●</span> Unanswered</div>
            <div><span class="badge" style="background:#ff9800">●</span> Marked</div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-9 p-3">
      <div class="timer-card" id="timer">Time Remaining: 30:00</div>
      <div class="progress mb-3" style="height:6px;">
        <div id="timerBar" class="progress-bar bg-warning" style="width: 100%"></div>
      </div>
      <div id="passage-section" class="md-card p-3 mb-3" style="display:none;">
        <h6>Read the passage carefully:</h6>
        <div style="max-height:200px;overflow-y:auto;">
          <p>Most human beings are awake during the day and sleep at night. Owls live the opposite way. Owls are nocturnal. This means that they sleep all day and stay awake at night. Because owls are nocturnal, this means they must eat at night. But finding food in the dark is difficult. To help them, they have special eyes and ears.</p>
          <p>Owls have very large eyes. These eyes absorb more light than normal. Since there is little light during the night, it is helpful to be able to absorb more of it. This helps owls find food in the dark.</p>
          <p>Owls also have very good hearing. Even when owls are in the trees, they can hear small animals moving in the grass below. This helps owls catch their prey even when it is very dark.</p>
          <p>Like owls, mice are also nocturnal animals. Mice have an excellent sense of smell. This helps them find food in the dark.</p>
          <p>Being nocturnal helps mice to hide from many different animals that want to eat them. Most of the birds, snakes and lizards that like to eat mice sleep at night — except, of course, owls!</p>
        </div>
      </div>
      <div class="md-card p-4 mb-3" id="question-area"></div>
      <div class="text-center">
        <button class="md-button me-2" onclick="prevQuestion()">Previous</button>
        <button class="md-button me-2" onclick="nextQuestion()">Next</button>
        <button class="md-button me-2" onclick="markForReview()" id="mark-btn">Mark for Review</button>
        <button class="md-button md-button-primary" onclick="submitQuiz()">Submit Test</button>
      </div>
    </div>
  </div>
</div>

<div id="result" class="container my-4" style="display:none;">
  <div class="card p-4 shadow">
    <!-- watermark image (will be set from lourds_logo_base64.txt at runtime) -->
    <img id="logo-watermark" class="logo-watermark" alt="watermark logo">
    <h3 class="mb-3">Quiz Result</h3>
    <p id="candidate-details"></p>
    <p>Total Questions: 30</p>
    <p>Attempted: <span id="attempted"></span></p>
    <p>Unattempted: <span id="unattempted"></span></p>
    <p>Score: <span id="score"></span> / 30</p>
    <p>Time Taken: <span id="time-taken"></span></p>
    <div id="answer-review" class="mt-3"></div>
    <button class="btn btn-info mt-3" onclick="downloadPDF()">Download Result as PDF</button>
  </div>
</div>

<script>
let currentQuestion = 0;
let selectedAnswers = Array(30).fill(null);
let markedQuestions = Array(30).fill(false);
let timerInterval;
let timeLeft = 1800;

const questions = [
  {q:"Find the italicized part in the sentence that is incorrect:", stem:`  {q:"Find the italicized part in the sentence that is incorrect:", stem:`<table style="border-collapse:collapse;width:auto"><tr style="vertical-align:bottom;font-size:1em"><td style="padding:0 2px">In some countries</td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>in Europe</em></span></td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>are allowed</em></span></td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>giving</em></span></td><td style="padding:0 2px">children some homework only</td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>at weekends</em></span></td><td style="padding:0 2px">.</td></tr><tr style="font-size:0.95em"><td></td><td style="text-align:center">1</td><td style="text-align:center">2</td><td style="text-align:center">3</td><td></td><td style="text-align:center">4</td><td></td></tr></table>`, options:["1","2","3","4"], parts:["in Europe","are allowed","giving","at weekends"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"When <span class='blank'>_____</span> this morning?", options:["did you woke up","did you wake up","have you woken up","were you woke up"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"We <span class='blank'>_____</span> volleyball yesterday.", options:["played","have played","had played","have been playing"]},
  {q:"Choose the correct word to complete the sentence:", stem:"There is very <span class='blank'>_____</span> petrol in the car. I'll buy some when I go out.", options:["few","much","a little","little"]},
  {q:"Choose the correct word to complete the sentence:", stem:"He apologized <span class='blank'>_____</span> being late.", options:["to","for","on","of"]},`, options:["1","2","3","4"], parts:["in Europe","are allowed","giving","at weekends"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"When <span class='blank'></span> this morning?", options:["did you woke up","did you wake up","have you woken up","were you woke up"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"We <span class='blank'></span> volleyball yesterday.", options:["played","have played","had played","have been playing"]},
  {q:"Choose the correct word to complete the sentence:", stem:"There is very <span class='blank'></span> petrol in the car. I’ll buy some when I go out.", options:["few","much","a little","little"]},
  {q:"Choose the correct word to complete the sentence:", stem:"He apologized <span class='blank'></span> being late.", options:["to","for","on","of"]},
  {q:"The word ‘diurnal’ is the opposite of the word nocturnal. Using information in the passage we can understand that an animal that is diurnal", stem:"", options:["sleeps at night and is awake during the day.","hunts during the day and is awake at night.","sleeps every other night and is awake during the day.","hunts at night and sleeps during the day."]},
  {q:"Based on information in paragraph 2, it can be understood that an animal with small eyes", stem:"", options:["must be diurnal.","has trouble seeing in the dark.","can see very well at night.","must be nocturnal."]},
  {q:"According to the passage, owls can find food in the dark using their sense of", stem:"", options:["sight only.","sight and sound.","sight, sound and smell.","sight and smell."]},
  {q:"In paragraph 3 the author writes: ‘This helps owls catch their prey when it is very dark.’ What is prey?", stem:"", options:["A noise that an animal makes during the night.","A small animal such as a pet dog or cat.","An animal that is hunted by other animals.","An enemy."]},
  {q:"According to the passage, mice sleep during the day in order to", stem:"", options:["find food that other animals cannot.","keep themselves safe.","store energy for night time activities.","stay awake at night."]},
  {q:"Using information in the last paragraph, it can be understood that", stem:"", options:["owls hunt mice.","mice can hide from owls.","mice and owls both hide from birds, snakes and lizards.","owls sleep at night."]},
  {q:"Which of the following conclusions would work best at the end of this passage?", stem:"", options:["The owl is a nocturnal animal. This means it is active at night. The owl’s excellent sense of sight and sound enables it to find food in the dark.","Mice are nocturnal animals. This means they are active at night. Similar to the owl, mice use their excellent sense of smell to find food in the dark.","Some animals are nocturnal. This means they are active at night. The owl and the mouse are good examples of animals that use their senses to find food in the dark.","The owl and the mouse sleep during the day and stay awake at night."]},
  {q:"Choose the right question to get the italicized part as the answer:", stem:"The children are sitting in the garden.", options:["Where do children sit?","Where have the children been sitting?","Where are the children sitting?","Where are they sitting?"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. blood II. moon III. soon IV. mood", options:["I – blood","II – moon","III – soon","IV – mood"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. bear II. dare III. fare IV. dear", options:["I – bear","II – dare","III – fare","IV – dear"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. enjoyed II. jumped III. died IV. filled", options:["I – enjoyed","II – jumped","III – died","IV – filled"]},
  {q:"Find the italicized part in the sentence that is incorrect:", stem:`<table style="border-collapse:collapse;width:auto"><tr style="vertical-align:bottom;font-size:1em"><td style="padding:0 2px">It is a</td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>well</em></span></td><td style="padding:0 2px">idea</td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>to encourage</em></span></td><td style="padding:0 2px">boys</td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>to learn</em></span></td><td style="padding:0 2px"> </td><td style="padding:0 2px;text-align:center"><span style="text-decoration:underline"><em>to cook</em></span></td><td style="padding:0 2px">.</td></tr><tr style="font-size:0.95em"><td></td><td style="text-align:center">1</td><td></td><td style="text-align:center">2</td><td></td><td style="text-align:center">3</td><td></td><td style="text-align:center">4</td><td></td></tr></table>`, options:["1","2","3","4"]},
  {q:"Choose the word which has almost the same meaning as the italicized one:", stem:"I help them to <em>assemble</em> the different parts.", options:["manufacture","store","check","fit"]},
  {q:"Choose the correct antonym for the italicized word:", stem:"Travelling is considered very <em>dangerous</em>.", options:["harmful","peaceful","safe","exciting"]},
  {q:"Choose the correct antonym for the italicized word:", stem:"This is a <em>common</em> thing.", options:["strange","funny","real","special"]},
  {q:"Read the short conversation and identify the language function:", stem:"Shrimathy: That remark was uncalled for.\nVenu: <em>I’m sorry, I shouldn’t have said it.</em>", options:["apologising","wishing","blaming","forgiving"]},
  {q:"Read the short conversation and identify the language function:", stem:"Arun: What shall we do this weekend?\nSheela: <em>Why don’t we go on a picnic?</em>", options:["welcoming","inviting","suggesting","advising"]},
  {q:"Choose the correct question tag:", stem:"Mary has answered all the questions,<span class='blank'></span>?", options:["doesn’t she","didn’t she","wasn’t she","hasn’t she"]},
  {q:"Choose the correct question tag:", stem:"Hanif wasn’t listening <span class='blank'></span>?", options:["was he","has he","did he","isn’t he"]},
  {q:"Choose the right question to get the italicized part as the answer:", stem:"Hari is writing a letter.", options:["What does Hari write?","What is Hari writing?","Who is writing a letter?","What is Hari doing?"]},
  {q:"Choose the correct word to complete the sentence:", stem:"We are satisfied <span class='blank'></span> our son’s progress this term.", options:["for","on","about","with"]},
  {q:"Which of the following is a form of the verb ‘be’?", stem:"", options:["may","am","can","will"]},
  {q:"The passive form of the sentence “The Blue team won the game” is:", stem:"", options:["The game is won by the Blue team.","The game has been won by the Blue team.","The game had been won by the Blue team.","The game was won by the Blue team."]},
  {q:"The reported form of the question “Renu said to me, ‘Is the movie interesting?’” is:", stem:"", options:["Renu asked me if the movie was interesting.","Renu asked me if the movie has been interesting.","Renu asked me if the movie is interesting.","Renu asked me if the movie had been interesting."]},
  {q:"Choose the word which has almost the same meaning as the italicized one:", stem:"She <em>seldom</em> goes to conferences", options:["nearly","rarely","slightly","incredibly"]}
];

const correctAnswers = [
  "C", // Q1: option 3 ("giving")
  "B", // Q2: b
  "A", // Q3: a
  "D", // Q4: d
  "B", // Q5: b
  "A", // Q6: a
  "C", // Q7: b
  "B", // Q8: b
  "C", // Q9: c
  "D", // Q10: b
  "A", // Q11: b
  "C", // Q12: c
  "C", // Q13: c
  "A", // Q14: a
  "D", // Q15: d
  "B", // Q16: b
  "A", // Q17: a
  "D", // Q18: d
  "C", // Q19: c
  "D", // Q20: a
  "apologising", // Q21: a
  "suggesting", // Q22: c
  "hasn’t she", // Q23: d
  "was he", // Q24: a
  "What is Hari writing?", // Q25: b
  "with", // Q26: d
  "am", // Q27: b
  "The game was won by the Blue team.", // Q28: d
  "Renu asked me if the movie was interesting.", // Q29: a
  "rarely" // Q30: b
];

function toggleCustomSubject() {
  const subjectSelect = document.getElementById('subject');
  const customSubjectDiv = document.getElementById('custom-subject-div');
  const customSubjectInput = document.getElementById('custom-subject');
  
  if(subjectSelect.value === 'Other') {
    customSubjectDiv.style.display = 'block';
    customSubjectInput.required = true;
  } else {
    customSubjectDiv.style.display = 'none';
    customSubjectInput.required = false;
    customSubjectInput.value = '';
  }
}

function startQuiz(){
  let name = document.getElementById('name').value.trim();
  let email = document.getElementById('email').value.trim();
  let phone = document.getElementById('phone').value.trim();
  let subject = document.getElementById('subject').value;
  
  // Handle custom subject
  if(subject === 'Other') {
    let customSubject = document.getElementById('custom-subject').value.trim();
    if(!customSubject) {
      alert("Please enter your subject");
      return;
    }
    subject = customSubject;
  }
  
  if(!name || !email || !phone || !subject){ 
    alert("Please fill all details"); 
    return;
  }
  window.candidateInfo = {name,email,phone,subject};
  document.querySelector('.container').style.display='none';
  document.getElementById('quiz').style.display='block';
  buildQuestionGrid();
  showQuestion(currentQuestion);
  startTimer();
}

function buildQuestionGrid(){
  let grid = document.getElementById('question-grid');
  for(let i=0;i<30;i++){
    let btn = document.createElement('button');
    btn.id = 'qbtn'+i;
    btn.innerText = i+1;
    btn.className = 'unanswered';
    btn.onclick = ()=>{currentQuestion=i; showQuestion(i);}
    grid.appendChild(btn);
  }
}

function showQuestion(index){
  currentQuestion = index;
  
  // Show passage only for Q6–Q12 (index 5–11)
  if (index >= 5 && index <= 11) {
    document.getElementById('passage-section').style.display = 'block';
  } else {
    document.getElementById('passage-section').style.display = 'none';
  }

  let q = questions[index];
  let html = `<div style="margin-bottom: 16px; font-weight: 500; font-size: 1.1em;">Q${index+1}. ${q.q}</div>`;
  
  if (q.stem) {
    html += `<div style="margin-bottom: 20px; line-height: 1.6; word-wrap: break-word;">${q.stem}</div>`;
  }
  
  for(let i=0;i<q.options.length;i++){
    let optionCode = String.fromCharCode(65 + i); // A, B, C, D
    let isSelected = selectedAnswers[index] === optionCode;
    html += `<div class="option-card">
      <input type="radio" name="option" id="opt${i}" value="${q.options[i]}" ${isSelected?'checked':''} onclick="selectOption('${q.options[i]}')">
      <label for="opt${i}" style="cursor: pointer; flex: 1; word-wrap: break-word;">${String.fromCharCode(97+i)}) ${q.options[i]}</label>
    </div>`;
  }
  document.getElementById('question-area').innerHTML = html;
  
  // Update mark button
  const markBtn = document.getElementById('mark-btn');
  if (markBtn) {
    if (markedQuestions[index]) {
      markBtn.textContent = 'Unmark Review';
      markBtn.className = 'md-button me-2';
      markBtn.style.background = '#6c757d';
      markBtn.style.color = 'white';
    } else {
      markBtn.textContent = 'Mark for Review';
      markBtn.className = 'md-button me-2';
      markBtn.style.background = '#ff9800';
      markBtn.style.color = 'white';
    }
  }
}

function selectOption(val){
  // Convert answer to option code (A, B, C, D)
  let q = questions[currentQuestion];
  let optionIndex = q.options.indexOf(val);
  let optionCode = String.fromCharCode(65 + optionIndex); // A=65, B=66, C=67, D=68
  selectedAnswers[currentQuestion] = optionCode;
  updateGridStatus();
}

function updateGridStatus(){
  let answeredCount = 0;
  for(let i=0;i<30;i++){
    let btn = document.getElementById('qbtn'+i);
    if(markedQuestions[i]) {
      btn.className = 'question-btn marked';
    } else if(selectedAnswers[i]) {
      btn.className = 'question-btn answered';
      answeredCount++;
    } else {
      btn.className = 'question-btn unanswered';
    }
  }
  document.getElementById('answered-count').textContent = answeredCount;
  document.getElementById('unanswered-count').textContent = 30 - answeredCount;
}

function nextQuestion(){ if(currentQuestion<29){ currentQuestion++; showQuestion(currentQuestion);} }
function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; showQuestion(currentQuestion);} }
function markForReview(){ 
  markedQuestions[currentQuestion] = !markedQuestions[currentQuestion]; 
  updateGridStatus();
  showQuestion(currentQuestion); // Refresh to update button text
}

function startTimer(){
  timerInterval = setInterval(()=>{
    timeLeft--;
    let min=Math.floor(timeLeft/60);
    let sec=timeLeft%60;
    document.getElementById('timer').innerText=`Time Remaining: ${min}:${sec<10?'0'+sec:sec}`;
    document.getElementById('timerBar').style.width=(timeLeft/1800*100)+'%';
    if(timeLeft<=0){ clearInterval(timerInterval); submitQuiz();}
  },1000);
}

function submitQuiz(){
  clearInterval(timerInterval);
  document.getElementById('quiz').style.display='none';
  document.getElementById('result').style.display='block';
  showResult();
  sendToGoogleSheet();
}

function sendToGoogleSheet() {
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const timeTakenSeconds = 1800 - timeLeft;
  const minutes = Math.floor(timeTakenSeconds / 60);
  const seconds = timeTakenSeconds % 60;
  const timeTaken = `${minutes}.${seconds.toString().padStart(2, '0')}`;

  const payload = {
    name,
    email,
    phone,
    subject,
    attempted,
    unattempted,
    score,
    timeTaken,
    answers: selectedAnswers
  };

  console.log("Sending payload:", payload);

  fetch("https://script.google.com/macros/s/AKfycbyCIF0KcmXBrIMiam0rDzsZB61TzJCvWodzoea5PrJuTgceiif46_oDq4tJRMKypbH3-w/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(txt => {
    console.log("Sheet response:", txt);
    document.getElementById("submission-status").innerText = "✅ Your response has been recorded and saved.";
  })
  .catch(err => {
    console.error("Error sending to sheet:", err);
    document.getElementById("submission-status").innerText = "⚠️ There was an error saving your response.";
  });
}


function showResult(){
  let {name,email,phone,subject} = window.candidateInfo;
  document.getElementById('candidate-details').innerHTML=`Name: ${name} | Email: ${email} | Phone: ${phone} | Subject: ${subject}`;
  let attempted=selectedAnswers.filter(a=>a!==null).length;
  document.getElementById('attempted').innerText=attempted;
  document.getElementById('unattempted').innerText=30-attempted;
  let score=0;
  let html="";
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userCode=selectedAnswers[i];
    let correctCode=correctAnswers[i];
    if(userCode==correctCode) score++;
    
    // Get full text for display with option codes
    let userText = userCode ? q.options[userCode.charCodeAt(0) - 65] || 'Invalid' : 'Not answered';
    let correctText = q.options[correctCode.charCodeAt(0) - 65] || 'Invalid';
    
    // Display format: "A) Full answer text"
    let userDisplay = userCode ? `${userCode}) ${userText}` : 'Not answered';
    let correctDisplay = `${correctCode}) ${correctText}`;
    
    html+=`<p><b>Q${i+1}:</b> ${q.stem}<br> Your answer: <span class="${userCode==correctCode?'correct':'wrong'}">${userDisplay}</span> | Correct: ${correctDisplay}</p>`;
  }
  document.getElementById('score').innerText=score;
  const timeTakenSeconds = 1800 - timeLeft;
  const minutes = Math.floor(timeTakenSeconds / 60);
  const seconds = timeTakenSeconds % 60;
  document.getElementById('time-taken').innerText = `${minutes}.${seconds.toString().padStart(2, '0')} minutes`;
  document.getElementById('answer-review').innerHTML=html;
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  // Use A4 size explicitly for alignment
  const doc = new jsPDF({format: 'a4', unit: 'mm'});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  // Watermark: Bookman Old Style (simulate with Times Bold), two centered per page
  // Draw one big watermark, diagonal, centered
  // Draw one big watermark, diagonal, fully across page, centered
  // Draw logo watermark in center
  function drawLogoWatermark() {
    // Use loaded base64 logo if available
    if(window.logoBase64){
      var img = 'data:image/png;base64,' + window.logoBase64;
      doc.addImage(img, 'PNG', pageWidth/2-30, pageHeight/2-30, 60, 60, undefined, 'NONE');
    }
  }
  drawLogoWatermark();
  // All other text in Roboto
  doc.setFont("helvetica", "normal");
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("LOURDS ENGLISH ACADEMY", pageWidth/2, 16, {align: "center"});
  doc.setFontSize(12);
  doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});
  doc.setFont(undefined, 'normal');
  let y=28;
  // Candidate details 4-column, 2-row table
  let detailsHeaders = ["Name", "Email", "Phone Number", "Subject"];
  let detailsValues = [window.candidateInfo.name, window.candidateInfo.email, window.candidateInfo.phone, window.candidateInfo.subject];
  let cellW = (pageWidth-20)/4;
  // Header row (light grey, black text)
  for(let i=0;i<4;i++){
    doc.setFillColor(230);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+cellW*i, y, cellW, 8, 'F');
    doc.text(detailsHeaders[i], 12+cellW*i, y+6);
  }
  y+=8;
  // Value row
  for(let i=0;i<4;i++){
    doc.setFillColor(255);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+cellW*i, y, cellW, 8, 'F');
    doc.text(detailsValues[i], 12+cellW*i, y+6);
  }
  y+=10;
  // Stats table 5 columns, 2 rows
  let statsHeaders = ["Total Questions", "Attempted", "Unattempted", "Score", "Time Taken"];
  let statsValues = [
    "30",
    `${selectedAnswers.filter(a=>a!==null).length}`,
    `${30-selectedAnswers.filter(a=>a!==null).length}`,
    `${document.getElementById('score').innerText} / 30`,
    `${1800-timeLeft} seconds`
  ];
  let statW = (pageWidth-20)/5;
  // Draw stats table with centered header and values, each cell bordered
  // Header row
  for(let i=0;i<5;i++){
    doc.setFillColor(230);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+statW*i, y, statW, 8, 'FD');
    doc.text(statsHeaders[i], 10+statW*i+statW/2, y+6, {align: "center"});
  }
  y+=8;
  // Value row
  for(let i=0;i<5;i++){
    doc.setFillColor(255);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+statW*i, y, statW, 8, 'FD');
    doc.text(statsValues[i], 10+statW*i+statW/2, y+6, {align: "center"});
  }
  y+=8;
  y+=4;
  // Helper to strip HTML
  function stripHTML(html) {
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }
  // Results table header (3 columns, black border, light grey fill)
  let resW = [(pageWidth-20)*0.12, (pageWidth-20)*0.44, (pageWidth-20)*0.44];
  doc.setFillColor(230);
  doc.setDrawColor(0);
  doc.setTextColor(0);
  doc.rect(10, y, resW[0], 10, 'FD');
  doc.rect(10+resW[0], y, resW[1], 10, 'FD');
  doc.rect(10+resW[0]+resW[1], y, resW[2], 10, 'FD');
  doc.setFont(undefined, 'bold');
  doc.text("Q.No.", 12, y+7);
  doc.text("Correct Answer", 12+resW[0], y+7);
  doc.text("Your Answer", 12+resW[0]+resW[1], y+7);
  doc.setFont(undefined, 'normal');
  y+=10;
  // Results table 30 rows, auto-adjust height for wrapped text
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userCode=selectedAnswers[i];
    let correctCode=correctAnswers[i];
    
    // Get full text for PDF display with option codes
    let userText = userCode ? q.options[userCode.charCodeAt(0) - 65] || 'Invalid' : 'Not answered';
    let correctText = q.options[correctCode.charCodeAt(0) - 65] || 'Invalid';
    
    // Format for PDF: "A) Full answer text"
    let userDisplay = userCode ? `${userCode}) ${userText}` : 'Not answered';
    let correctDisplay = `${correctCode}) ${correctText}`;
    
    let correctLines = doc.splitTextToSize(stripHTML(correctDisplay), resW[1]-4);
    let userLines = doc.splitTextToSize(stripHTML(userDisplay), resW[2]-4);
    let rowHeight = Math.max(correctLines.length, userLines.length, 1)*6+2;
    // Draw row
    doc.rect(10, y, resW[0], rowHeight);
    doc.rect(10+resW[0], y, resW[1], rowHeight);
    doc.rect(10+resW[0]+resW[1], y, resW[2], rowHeight);
    doc.text(`${i+1}`, 12, y+7);
    doc.text(correctLines, 12+resW[0], y+7);
    if(userCode==correctCode){
      doc.setTextColor(0,128,0);
    }else{
      doc.setTextColor(220,0,0);
    }
    doc.text(userLines, 12+resW[0]+resW[1], y+7);
    doc.setTextColor(0);
    y+=rowHeight;
    if(y>pageHeight-30){
      doc.addPage();
      // ensure watermark on new page as well
      drawLogoWatermark();
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("LOURDS ENGLISH ACADEMY", pageWidth/2, 16, {align: "center"});
      doc.setFontSize(12);
      doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});
      doc.setFont(undefined, 'normal');
      y=28;
      // Candidate details table
      for(let i=0;i<4;i++){
        doc.setFillColor(230);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+cellW*i, y, cellW, 8, 'F');
        doc.text(detailsHeaders[i], 12+cellW*i, y+6);
      }
      y+=8;
      for(let i=0;i<4;i++){
        doc.setFillColor(255);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+cellW*i, y, cellW, 8, 'F');
        doc.text(detailsValues[i], 12+cellW*i, y+6);
      }
      y+=10;
      for(let i=0;i<5;i++){
        doc.setFillColor(230);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+statW*i, y, statW, 8, 'F');
        doc.text(statsHeaders[i], 12+statW*i, y+6);
      }
      y+=8;
      for(let i=0;i<5;i++){
        doc.setFillColor(255);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+statW*i, y, statW, 8, 'F');
        doc.text(statsValues[i], 12+statW*i, y+6);
      }
      y+=12;
      // Results table header
      doc.setFillColor(230);
      doc.setDrawColor(0);
      doc.setTextColor(0);
      doc.rect(10, y, resW[0], 10, 'FD');
      doc.rect(10+resW[0], y, resW[1], 10, 'FD');
      doc.rect(10+resW[0]+resW[1], y, resW[2], 10, 'FD');
      doc.setFont(undefined, 'bold');
      doc.text("Q.No.", 12, y+7);
      doc.text("Correct Answer", 12+resW[0], y+7);
      doc.text("Your Answer", 12+resW[0]+resW[1], y+7);
      doc.setFont(undefined, 'normal');
      y+=10;
    }
  }
  // Footer: page number (left), timestamp (right)
  let pageCount = doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(10);
    doc.text(`Page ${i}`, 10, pageHeight-2);
    let now = new Date();
    let ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    doc.text(ts, pageWidth-50, pageHeight-2);
  }
  doc.save("Quiz_Result.pdf");
}

// Set test name in header (use document.title, fallback to filename)
(function(){
  try {
    var tn = document.title && document.title.trim() ? document.title.trim() : (location.pathname.split('/').pop() || '');
    // remove extension if present
    tn = tn.replace(/\.[^.]+$/, '');
    document.getElementById('test-name').innerText = tn ? ('- ' + tn) : '';
  } catch(e) { /* silent */ }
})();

// Load base64 logo file (lourds_logo_base64.txt) from same folder and apply it as watermark.
(function(){
  fetch('lourds_logo_base64.txt')
    .then(res => res.text())
    .then(text => {
      const b64 = text.trim();
      if(!b64) return;
      // strip any leading data: URI prefix if present
      window.logoBase64 = b64.replace(/^data:image\/[a-z]+;base64,/, '');
      const imgEl = document.getElementById('logo-watermark');
      if(imgEl){
        imgEl.src = 'data:image/png;base64,' + window.logoBase64;
        imgEl.style.display = 'block';
      }
    })
    .catch(err => { console.warn('Could not load logo base64:', err); });
})();
</script>

</body>
</html>
