<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TET Test 2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
function sendToGoogleSheet() {
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const timeTaken = (1800 - timeLeft) + " seconds";

  const payload = {
    quizName: "Test2",
    name,
    email,
    phone,
    subject,
    attempted,
    unattempted,
    score,
    timeTaken,
    answers: selectedAnswers
  };

  
  console.log("Sending payload:", payload);
fetch("https://script.google.com/macros/s/AKfycbyCIF0KcmXBrIMiam0rDzsZB61TzJCvWodzoea5PrJuTgceiif46_oDq4tJRMKypbH3-w/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(txt => console.log("Sheet response:", txt))
  .catch(err => console.error("Error sending to sheet:", err));
}

</script>
<style>
  em {
    font-family: 'Roboto', Arial, sans-serif;
    font-style: italic;
    font-weight: bold;
    font-size: 1.05em;
    color: #2a2a2a;
  }
  .blank {
    display: inline-block;
    border-bottom: 1px solid #333;
    min-width: 60px;
    height: 1.2em;
    vertical-align: middle;
    margin: 0 4px;
  }
  body, #quiz, #question-area, .option-div, .timer {
    font-family: 'Roboto', Arial, sans-serif;
    background:#f0f2f5;
  }
  #question-grid button { width: 30px; height: 30px; margin: 2px; color: white; font-weight: bold; border-radius: 4px; border: none; font-size: 12px; }
  .unanswered { background-color: #dc3545; }
  .answered { background-color: #28a745; }
  .marked { background-color: #6f42c1; }
    .passage-container {
    max-height: 280px;
    overflow-y: auto;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 20px;
    color: white;
    line-height: 1.6;
  }
  
  .passage-container::-webkit-scrollbar {
    width: 8px;
  }
  
  .passage-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 4px;
  }
  
  .passage-container::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
  }
  
  .passage-container::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
  }
  .timer { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
  .correct { color: green; font-weight: bold; }
  .wrong { color: red; font-weight: bold; }
  .progress { height: 20px; margin-bottom: 15px; }
  .option-div {
    margin: 0 0 0 8px;
    padding: 0;
    line-height: 1.2;
    display: flex;
    align-items: center;
  }
  .option-div label { display: inline; margin-left: 6px; }
  #result { position: relative; }
  /* Use a real image watermark instead of pseudo-element text */
  #result .card { position: relative; z-index: 1; }
  .logo-watermark {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-30deg);
    width: 300px; /* adjust as needed */
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
    display: none;
  }

  /* Fixed site header to show brand and test name across all pages */
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 56px;
    background: #fff;
    border-bottom: 1px solid #e6e6e6;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    z-index: 1100;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
  }
  .site-header .brand { font-weight: 700; font-size: 1.05rem; color: #222; }
  .site-header .testname { font-size: 0.95rem; color: #555; }
  /* Ensure page content is not hidden behind fixed header */
  body { padding-top: 72px; }
  
  /* Mobile responsiveness for underlined text in questions */
  @media (max-width: 768px) {
    .option-div {
      margin: 5px 0;
      flex-wrap: wrap;
    }
    
    .option-div label {
      word-break: break-word;
      line-height: 1.4;
    }
    
    /* Better wrapping for underlined elements */
    u, em {
      display: inline-block;
      word-break: break-word;
      max-width: 100%;
    }
    
    /* Prevent text overflow in question stems */
    #question-area div {
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  }
  
  /* Mobile responsiveness for underlined text in questions */
  @media (max-width: 768px) {
    .option-div {
      margin: 5px 0;
      flex-wrap: wrap;
    }
    
    .option-div label {
      word-break: break-word;
      line-height: 1.4;
    }
    
    /* Better wrapping for underlined elements */
    u, em {
      display: inline-block;
      word-break: break-word;
    }
  }
</style>
</head>
<body>
  <!-- Fixed header visible on every page -->
  <header class="site-header" role="banner" aria-label="Site header">
    <div class="brand">LOURDS ENGLISH ACADEMY</div>
    <div id="test-name" class="testname"></div>
  </header>

<div class="container my-4">
  <div id="login" class="card p-4 shadow">
    <h3 class="mb-3">Enter Candidate Details</h3>
    <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" required>
    <input type="tel" id="phone" class="form-control mb-2" placeholder="Phone Number" required>
    <select id="subject" class="form-select mb-2" required>
      <option value="">Select Subject</option>
      <option>Tamil</option><option>English</option><option>Maths</option><option>Physics</option>
      <option>Chemistry</option><option>Botony</option><option>Zoology</option><option>History</option><option>Geography</option>
    </select>
    <button class="btn btn-primary mt-2" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<div id="quiz" class="container-fluid" style="display:none;">
  <div class="row">
    <div class="col-md-2 bg-white p-3 shadow">
      <h5 class="text-center mb-3">Questions</h5>
      <div id="question-grid" class="d-flex flex-wrap justify-content-center"></div>
      <div class="mt-3 text-center">
        <span class="fw-bold">Green:</span> Answered<br>
        <span class="fw-bold">Red:</span> Unanswered<br>
        <span class="fw-bold">Purple:</span> Marked
      </div>
      <div class="answer-counts text-center">
        <div class="small">Answered: <span id="answered-count" class="fw-bold text-success">0</span></div>
        <div class="small">Unanswered: <span id="unanswered-count" class="fw-bold text-danger">30</span></div>
      </div>
    </div>
    <div class="col-md-10 p-4">
      <div class="timer text-end" id="timer">Time Remaining: 30:00</div>
      <div class="progress mb-3">
        <div id="timerBar" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
      </div>
      <div id="passage-section" class="passage-container" style="display:none;">
        <h5 style="color: white; margin-bottom: 16px;">📖 Read the passage carefully:</h5>
        <p>Most of us use the products of science – railways, aeroplanes, electricity, phones and thousands of others – without thinking how they came into existence. We take them for granted, as if we are entitled to them as a matter of right. And we are very proud of the fact that we live in an advanced age and are ourselves so very advanced.</p>
        <p>There is no doubt that our age is a very different one from previous ages and I think it is perfectly correct to say that it is far more advanced. But that is a different thing from saying that we as individuals or groups are more advanced.</p>
        <p>It would be the height of absurdity to say that because an engine driver can run an engine and Plato or Socrates could not, the engine driver is more advanced than, or is superior to Plato or Socrates. But it would be perfectly correct to say that the engine itself is a more advanced method of locomotion than Plato's chariot was.</p>
      </div>
      <div class="card p-3 mb-3 shadow" id="question-area"></div>
      <div class="mb-4">
        <button class="btn btn-secondary me-2" onclick="prevQuestion()">Previous</button>
        <button class="btn btn-secondary me-2" onclick="nextQuestion()">Next</button>
        <button class="btn btn-warning me-2" id="mark-btn" onclick="toggleMarkForReview()">Mark for Review</button>
        <button class="btn btn-success" onclick="submitQuiz()">Submit Test</button>
      </div>
    </div>
  </div>
</div>

<div id="result" class="container my-4" style="display:none;">
  <div class="card p-4 shadow">
    <!-- watermark image (will be set from lourds_logo_base64.txt at runtime) -->
    <img id="logo-watermark" class="logo-watermark" alt="watermark logo">
    <h3 class="mb-3">Quiz Result</h3>
    <p id="candidate-details"></p>
    <p>Total Questions: 30</p>
    <p>Attempted: <span id="attempted"></span></p>
    <p>Unattempted: <span id="unattempted"></span></p>
    <p>Score: <span id="score"></span> / 30</p>
    <p>Time Taken: <span id="time-taken"></span></p>
    <div id="answer-review" class="mt-3"></div>
    <button class="btn btn-info mt-3" onclick="downloadPDF()">Download Result as PDF</button>
  </div>
</div>

<script>
let currentQuestion = 0;
let selectedAnswers = Array(30).fill(null);
let markedQuestions = Array(30).fill(false);
let timerInterval;
let timeLeft = 1800;

const questions = [
  {q:"Pick out the adjective which can best fill in the blank:", stem:"The <span class='blank'></span> chapters are lacking in interest.", options:["later","latest","latter","letter"]},
  {q:"Which is the most appropriate passive form of the sentence?", stem:"\"One should keep one's promises\"", options:["We should keep our promises","Promises should be kept","Promises need not be kept","Promises may be kept"]},
  {q:"The most appropriate conversion to a simple sentence from:", stem:"\"We must eat, or we cannot live\" is —", options:["We must live to eat","We must not live to eat","We must eat and live","We must eat to live"]},
  {q:"In which classification of work can we categorise teaching?", stem:"", options:["Clerical","Managerial","Skilled","Professional"]},
  {q:"Choose the most appropriate complementary closing for a letter addressed to Sub-Inspector of Police:", stem:"", options:["Yours lovingly","Lovingly yours","Yours truly","Yours affectionately"]},
  {q:"Sequence the sentences properly:", stem:"S1 – There was no limit to insanitation<br>S6 – So I asked for a broom to clean them myself.<br>P – There were only a few latrines<br>Q – They refused point-blank to clean them<br>R – Pools of water were everywhere<br>S – I pointed it out to the volunteers<br>Proper sequence is —", options:["RSPQ","QPSR","RPSQ","QSPR"]},
  {q:"Identify the one italicized expression that must be changed:", stem:"Things will be <u><em>A better</em></u> if I <u><em>B will get</em></u> a job and <u><em>C earn</em></u> some money. Then I <u><em>D won't have</em></u> to live with my parents.", options:["A","B","C","D"]},
  {q:"Identify the one that must be changed:", stem:"The company <u><em>A claimed</em></u> to bring the best products and services <u><em>B</em></u> <u><em>C on</em></u> the doorstep of <u><em>D their consumers</em></u>", options:["A","B","C","D"]},
  {q:"Identify the errors:", stem:"It is raining. Mohan and Sumesh were walking on the park. The path is wet. Mohan slips and fell.", options:["raining, were, on","were, on, fell","were, on, slips","were, slips, fell"]},
  {q:"Choose the most appropriate clause:", stem:"Madhu met a girl with blue eyes.", options:["Whose eyes are blue","Whose eyes were blue","Those eyes were blue","Those eyes are blue"]},
  {q:"In the sentence 'The train came rushing down the hill', the word 'down' functions as —", stem:"", options:["Noun","Preposition","Verb","Adverb"]},
  {q:"Fill in the blank:", stem:"Smt. Sheela became <span class='blank'></span> Principal of the College in 2005.", options:["a","the","an","no article"]},
  {q:"Pick the odd one:", stem:"Pretty, attractive, beautiful, smart, lively", options:["Attractive","Lively","Beautiful","Pretty"]},
  {q:"Which of the following is not an instruction?", stem:"", options:["What an idea","Sit down","Be silent","Queue up"]},
  {q:"Which one of the following statements is correct?", stem:"", options:["An engine driver cannot be compared to Plato or Socrates","Plato or Socrates is in no way inferior to the engine driver","Plato or Socrates surpassed the engine driver in every respect","An engine driver is cleverer than Plato or Socrates"]},
  {q:"People today are very proud because they —", stem:"", options:["live in a philosophically advanced age","live in a spiritually advanced age","enjoy digital communications","live in a scientifically advanced age"]},
  {q:"Many of us make use of machines —", stem:"", options:["with full knowledge of their genesis","without knowing how they were invented","with very little knowledge of their mechanism","without any knowledge of their historical significance"]},
  {q:"Plato and Socrates are mentioned to emphasize that —", stem:"", options:["They had a great respect for learning","They were men of great scholarship","People as individuals today are not more advanced than their predecessors","The engine is a better mode of locomotion"]},
  {q:"The phrase 'height of absurdity' implies —", stem:"", options:["The possible extent of rationality","The impossible extent of rationality","The possible extent of irrationality","The impossible extent of rationality"]},
  {q:"If a medal is an award made of gold, silver or bronze, choose the homophone:", stem:"", options:["Meddle","Muddle","Middle","Medel"]},
  {q:"Verbal guidance is least effective in the learning of —", stem:"", options:["Attitudes","Relationships","Skills","Facts"]},
  {q:"My landlady was very <span class='blank'></span> when I met with an accident.", stem:"", options:["Merciful","Pitiful","Sympathetic","Hearty"]},
  {q:"The receptionist <span class='blank'></span> to ring another hotel.", stem:"", options:["Offered","Suggested","Recommended","Invited"]},
  {q:"I assure you I have no wish to <span class='blank'></span> my responsibility.", stem:"", options:["Shirk","Refuse","Abandon","Disobey"]},
  {q:"Has there been any <span class='blank'></span> on the strike from the Government?", stem:"", options:["Reaction","Response","Comment","Criticism"]},
  {q:"The boy backed up his friend's claim. The idiom means —", stem:"", options:["Accepted","Supported","Explained","Denied"]},
  {q:"Choose the appropriate tag:", stem:"Have some rice, <span class='blank'></span>?", options:["Will you","Shall you","May you","Won't you"]},
  {q:"Fill the blanks:", stem:"I met a boy <span class='blank'></span> told me <span class='blank'></span> I could find you.", options:["Who, were","That, were","That, where","Who, where"]},
  {q:"Dr. A.P.J. Abdul Kalam has consented to address students. Which discourse is best for informing parents?", stem:"", options:["Letter","Diary","Notice","Slogan"]},
  {q:"How many syllables are there in the word 'examination'?", stem:"", options:["4","3","5","6"]}
];

const correctAnswers = [
  "C", // Q1: c - latter
  "B", // Q2: b - Promises should be kept
  "D", // Q3: d - We must eat to live
  "D", // Q4: d - Professional
  "C", // Q5: c - Yours truly
  "C", // Q6: c - RPSQ
  "B", // Q7: B - will get should be get
  "D", // Q8: D - their consumers should be its consumers
  "D", // Q9: d - were, slips, fell
  "B", // Q10: b - Whose eyes were blue
  "D", // Q11: d - Adverb
  "D", // Q12: d - no article
  "B", // Q13: b - Lively
  "A", // Q14: a - What an idea
  "B", // Q15: b - Plato or Socrates is in no way inferior to the engine driver
  "D", // Q16: d - live in a scientifically advanced age
  "B", // Q17: b - without knowing how they were invented
  "C", // Q18: c - People as individuals today are not more advanced than their predecessors
  "D", // Q19: d - The impossible extent of rationality
  "A", // Q20: a - Meddle
  "C", // Q21: c - Skills
  "C", // Q22: c - Sympathetic
  "A", // Q23: a - Offered
  "A", // Q24: a - Shirk
  "C", // Q25: c - Comment
  "B", // Q26: b - Supported
  "A", // Q27: a - Will you
  "D", // Q28: d - Who, where
  "C", // Q29: c - Notice
  "C" // Q30: c - 5
];

function startQuiz(){
  let name = document.getElementById('name').value.trim();
  let email = document.getElementById('email').value.trim();
  let phone = document.getElementById('phone').value.trim();
  let subject = document.getElementById('subject').value;
  if(!name || !email || !phone || !subject){ alert("Please fill all details"); return;}
  window.candidateInfo = {name,email,phone,subject};
  document.getElementById('login').style.display='none';
  document.getElementById('quiz').style.display='block';
  buildQuestionGrid();
  showQuestion(currentQuestion);
  startTimer();
}

function buildQuestionGrid(){
  let grid = document.getElementById('question-grid');
  for(let i=0;i<30;i++){
    let btn = document.createElement('button');
    btn.id = 'qbtn'+i;
    btn.innerText = i+1;
    btn.className = 'unanswered';
    btn.onclick = ()=>{
      // Add click animation
      btn.style.transform = 'scale(0.9)';
      setTimeout(() => {
        btn.style.transform = 'scale(1)';
        currentQuestion=i; 
        showQuestion(i);
      }, 100);
    }
    // Add staggered entrance animation
    btn.style.opacity = '0';
    btn.style.transform = 'translateY(20px)';
    setTimeout(() => {
      btn.style.opacity = '1';
      btn.style.transform = 'translateY(0)';
    }, i * 50);
    
    grid.appendChild(btn);
  }
}

function showQuestion(index){
  // Add smooth transition effect
  const questionArea = document.getElementById('question-area');
  questionArea.style.opacity = '0.6';
  questionArea.style.transform = 'translateY(10px)';

  setTimeout(() => {
    // Show passage only for Q15–Q19 (index 14–18)
    if (index >= 14 && index <= 18) {
      document.getElementById('passage-section').style.display = 'block';
    } else {
      document.getElementById('passage-section').style.display = 'none';
    }

    let q = questions[index];
    let html = `<div><b>Q${index+1}. ${q.q}</b></div>`;
    html += `<div>${q.stem}</div>`;
    const optionCodes = ['a)', 'b)', 'c)', 'd)'];
    for(let i=0;i<q.options.length;i++){
      let optionCode = String.fromCharCode(65 + i); // A, B, C, D
      let isSelected = selectedAnswers[index] === optionCode;
      html += `<div class="option-div"><input type="radio" name="option" id="opt${i}" value="${q.options[i]}" ${isSelected?'checked':''} onclick="selectOption('${q.options[i]}')"> <label for="opt${i}">${optionCodes[i] ? optionCodes[i] : String.fromCharCode(97+i)+')'} ${q.options[i]}</label></div>`;
    }
    questionArea.innerHTML = html;
    
    // Update mark button text
    const markBtn = document.getElementById('mark-btn');
    if (markedQuestions[index]) {
      markBtn.textContent = 'Unmark Review';
      markBtn.className = 'btn btn-secondary me-2';
    } else {
      markBtn.textContent = 'Mark for Review';
      markBtn.className = 'btn btn-warning me-2';
    }
    
    // Animate back in
    questionArea.style.opacity = '1';
    questionArea.style.transform = 'translateY(0)';
  }, 150);
}

function selectOption(val){
  // Add visual feedback for selection
  const optionDivs = document.querySelectorAll('.option-div');
  optionDivs.forEach(div => {
    div.style.transform = 'scale(0.98)';
    setTimeout(() => {
      div.style.transform = 'scale(1)';
    }, 100);
  });

  // Convert answer to option code (A, B, C, D)
  let q = questions[currentQuestion];
  let optionIndex = q.options.indexOf(val);
  let optionCode = String.fromCharCode(65 + optionIndex); // A=65, B=66, C=67, D=68
  selectedAnswers[currentQuestion] = optionCode;
  updateGridStatus();
}

function updateGridStatus(){
  let answeredCount = 0;
  for(let i=0;i<30;i++){
    let btn = document.getElementById('qbtn'+i);
    if(markedQuestions[i]) btn.className='marked';
    else if(selectedAnswers[i]) {
      btn.className='answered';
      answeredCount++;
    }
    else btn.className='unanswered';
  }
  document.getElementById('answered-count').textContent = answeredCount;
  document.getElementById('unanswered-count').textContent = 30 - answeredCount;
}

function nextQuestion(){ if(currentQuestion<29){ currentQuestion++; showQuestion(currentQuestion);} }
function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; showQuestion(currentQuestion);} }
function toggleMarkForReview(){ 
  markedQuestions[currentQuestion] = !markedQuestions[currentQuestion]; 
  updateGridStatus();
  showQuestion(currentQuestion); // Refresh to update button text
}

function startTimer(){
  timerInterval = setInterval(()=>{
    timeLeft--;
    let min=Math.floor(timeLeft/60);
    let sec=timeLeft%60;
    const timerEl = document.getElementById('timer');
    timerEl.innerText=`Time Remaining: ${min}:${sec<10?'0'+sec:sec}`;
    
    // Add warning classes based on time left
    timerEl.classList.remove('warning', 'danger');
    if (timeLeft <= 300) { // 5 minutes
      timerEl.classList.add('warning');
    }
    if (timeLeft <= 60) { // 1 minute
      timerEl.classList.add('danger');
    }
    
    document.getElementById('timerBar').style.width=(timeLeft/1800*100)+'%';
    if(timeLeft<=0){ clearInterval(timerInterval); submitQuiz();}
  },1000);
}

function submitQuiz(){
  clearInterval(timerInterval);
  document.getElementById('quiz').style.display='none';
  document.getElementById('result').style.display='block';
  showResult();
  sendToGoogleSheet();
}

function sendToGoogleSheet() {
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const timeTakenSeconds = 1800 - timeLeft;
  const minutes = Math.floor(timeTakenSeconds / 60);
  const seconds = timeTakenSeconds % 60;
  const timeTaken = `${minutes}.${seconds.toString().padStart(2, '0')}`;

  const payload = {
    quizName: "Test2",
    name,
    email,
    phone,
    subject,
    attempted,
    unattempted,
    score,
    timeTaken,
    answers: selectedAnswers
  };

  console.log("Sending payload:", payload);

  fetch("https://script.google.com/macros/s/AKfycbyCIF0KcmXBrIMiam0rDzsZB61TzJCvWodzoea5PrJuTgceiif46_oDq4tJRMKypbH3-w/exec", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.text())
  .then(txt => {
    console.log("Sheet response:", txt);
    document.getElementById("submission-status").innerText = "✅ Your response has been recorded and saved.";
  })
  .catch(err => {
    console.error("Error sending to sheet:", err);
    document.getElementById("submission-status").innerText = "⚠️ There was an error saving your response.";
  });
}


function showResult(){
  let {name,email,phone,subject} = window.candidateInfo;
  document.getElementById('candidate-details').innerHTML=`Name: ${name} | Email: ${email} | Phone: ${phone} | Subject: ${subject}`;
  let attempted=selectedAnswers.filter(a=>a!==null).length;
  document.getElementById('attempted').innerText=attempted;
  document.getElementById('unattempted').innerText=30-attempted;
  let score=0;
  let html="";
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userCode=selectedAnswers[i];
    let correctCode=correctAnswers[i];
    if(userCode==correctCode) score++;
    
    // Get full text for display with option codes
    let userText = userCode ? q.options[userCode.charCodeAt(0) - 65] || 'Invalid' : 'Not answered';
    let correctText = q.options[correctCode.charCodeAt(0) - 65] || 'Invalid';
    
    // Display format: "A) Full answer text"
    let userDisplay = userCode ? `${userCode}) ${userText}` : 'Not answered';
    let correctDisplay = `${correctCode}) ${correctText}`;
    
    html+=`<p><b>Q${i+1}:</b> ${q.stem}<br> Your answer: <span class="${userCode==correctCode?'correct':'wrong'}">${userDisplay}</span> | Correct: ${correctDisplay}</p>`;
  }
  document.getElementById('score').innerText=score;
  let timeTakenSeconds = 1800-timeLeft;
  let minutes = Math.floor(timeTakenSeconds / 60);
  let seconds = timeTakenSeconds % 60;
  document.getElementById('time-taken').innerText=`${minutes}.${seconds.toString().padStart(2, '0')}`;
  document.getElementById('answer-review').innerHTML=html;
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  // Use A4 size explicitly for alignment
  const doc = new jsPDF({format: 'a4', unit: 'mm'});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  // Watermark: Bookman Old Style (simulate with Times Bold), two centered per page
  // Draw one big watermark, diagonal, centered
  // Draw one big watermark, diagonal, fully across page, centered
  // Draw logo watermark in center
  function drawLogoWatermark() {
    // Use loaded base64 logo if available
    if(window.logoBase64){
      var img = 'data:image/png;base64,' + window.logoBase64;
      doc.addImage(img, 'PNG', pageWidth/2-30, pageHeight/2-30, 60, 60, undefined, 'NONE');
    }
  }
  drawLogoWatermark();
  // All other text in Roboto
  doc.setFont("helvetica", "normal");
  doc.setFontSize(14);
  doc.setFont(undefined, 'bold');
  doc.text("LOURDS ENGLISH ACADEMY", pageWidth/2, 16, {align: "center"});
  doc.setFontSize(12);
  doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});
  doc.setFont(undefined, 'normal');
  let y=28;
  // Candidate details 4-column, 2-row table
  let detailsHeaders = ["Name", "Email", "Phone Number", "Subject"];
  let detailsValues = [window.candidateInfo.name, window.candidateInfo.email, window.candidateInfo.phone, window.candidateInfo.subject];
  let cellW = (pageWidth-20)/4;
  // Header row (light grey, black text)
  for(let i=0;i<4;i++){
    doc.setFillColor(230);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+cellW*i, y, cellW, 8, 'F');
    doc.text(detailsHeaders[i], 12+cellW*i, y+6);
  }
  y+=8;
  // Value row
  for(let i=0;i<4;i++){
    doc.setFillColor(255);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+cellW*i, y, cellW, 8, 'F');
    doc.text(detailsValues[i], 12+cellW*i, y+6);
  }
  y+=10;
  // Stats table 5 columns, 2 rows
  let statsHeaders = ["Total Questions", "Attempted", "Unattempted", "Score", "Time Taken"];
  let statsValues = [
    "30",
    `${selectedAnswers.filter(a=>a!==null).length}`,
    `${30-selectedAnswers.filter(a=>a!==null).length}`,
    `${document.getElementById('score').innerText} / 30`,
    `${1800-timeLeft} seconds`
  ];
  let statW = (pageWidth-20)/5;
  // Draw stats table with centered header and values, each cell bordered
  // Header row
  for(let i=0;i<5;i++){
    doc.setFillColor(230);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+statW*i, y, statW, 8, 'FD');
    doc.text(statsHeaders[i], 10+statW*i+statW/2, y+6, {align: "center"});
  }
  y+=8;
  // Value row
  for(let i=0;i<5;i++){
    doc.setFillColor(255);
    doc.setDrawColor(0);
    doc.setTextColor(0);
    doc.rect(10+statW*i, y, statW, 8, 'FD');
    doc.text(statsValues[i], 10+statW*i+statW/2, y+6, {align: "center"});
  }
  y+=8;
  y+=4;
  // Helper to strip HTML
  function stripHTML(html) {
    var tmp = document.createElement("DIV");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }
  // Results table header (3 columns, black border, light grey fill)
  let resW = [(pageWidth-20)*0.12, (pageWidth-20)*0.44, (pageWidth-20)*0.44];
  doc.setFillColor(230);
  doc.setDrawColor(0);
  doc.setTextColor(0);
  doc.rect(10, y, resW[0], 10, 'FD');
  doc.rect(10+resW[0], y, resW[1], 10, 'FD');
  doc.rect(10+resW[0]+resW[1], y, resW[2], 10, 'FD');
  doc.setFont(undefined, 'bold');
  doc.text("Q.No.", 12, y+7);
  doc.text("Correct Answer", 12+resW[0], y+7);
  doc.text("Your Answer", 12+resW[0]+resW[1], y+7);
  doc.setFont(undefined, 'normal');
  y+=10;
  // Results table 30 rows, auto-adjust height for wrapped text
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userCode=selectedAnswers[i];
    let correctCode=correctAnswers[i];
    
    // Get full text for PDF display with option codes
    let userText = userCode ? q.options[userCode.charCodeAt(0) - 65] || 'Invalid' : 'Not answered';
    let correctText = q.options[correctCode.charCodeAt(0) - 65] || 'Invalid';
    
    // Format for PDF: "A) Full answer text"
    let userDisplay = userCode ? `${userCode}) ${userText}` : 'Not answered';
    let correctDisplay = `${correctCode}) ${correctText}`;
    
    let correctLines = doc.splitTextToSize(stripHTML(correctDisplay), resW[1]-4);
    let userLines = doc.splitTextToSize(stripHTML(userDisplay), resW[2]-4);
    let rowHeight = Math.max(correctLines.length, userLines.length, 1)*6+2;
    // Draw row
    doc.rect(10, y, resW[0], rowHeight);
    doc.rect(10+resW[0], y, resW[1], rowHeight);
    doc.rect(10+resW[0]+resW[1], y, resW[2], rowHeight);
    doc.text(`${i+1}`, 12, y+7);
    doc.text(correctLines, 12+resW[0], y+7);
    if(userCode==correctCode){
      doc.setTextColor(0,128,0);
    }else{
      doc.setTextColor(220,0,0);
    }
    doc.text(userLines, 12+resW[0]+resW[1], y+7);
    doc.setTextColor(0);
    y+=rowHeight;
    if(y>pageHeight-30){
      doc.addPage();
      // ensure watermark on new page as well
      drawLogoWatermark();
      doc.setFont("helvetica", "normal");
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text("LOURDS ENGLISH ACADEMY", pageWidth/2, 16, {align: "center"});
      doc.setFontSize(12);
      doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});
      doc.setFont(undefined, 'normal');
      y=28;
      // Candidate details table
      for(let i=0;i<4;i++){
        doc.setFillColor(230);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+cellW*i, y, cellW, 8, 'F');
        doc.text(detailsHeaders[i], 12+cellW*i, y+6);
      }
      y+=8;
      for(let i=0;i<4;i++){
        doc.setFillColor(255);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+cellW*i, y, cellW, 8, 'F');
        doc.text(detailsValues[i], 12+cellW*i, y+6);
      }
      y+=10;
      for(let i=0;i<5;i++){
        doc.setFillColor(230);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+statW*i, y, statW, 8, 'F');
        doc.text(statsHeaders[i], 12+statW*i, y+6);
      }
      y+=8;
      for(let i=0;i<5;i++){
        doc.setFillColor(255);
        doc.setDrawColor(0);
        doc.setTextColor(0);
        doc.rect(10+statW*i, y, statW, 8, 'F');
        doc.text(statsValues[i], 12+statW*i, y+6);
      }
      y+=12;
      // Results table header
      doc.setFillColor(230);
      doc.setDrawColor(0);
      doc.setTextColor(0);
      doc.rect(10, y, resW[0], 10, 'FD');
      doc.rect(10+resW[0], y, resW[1], 10, 'FD');
      doc.rect(10+resW[0]+resW[1], y, resW[2], 10, 'FD');
      doc.setFont(undefined, 'bold');
      doc.text("Q.No.", 12, y+7);
      doc.text("Correct Answer", 12+resW[0], y+7);
      doc.text("Your Answer", 12+resW[0]+resW[1], y+7);
      doc.setFont(undefined, 'normal');
      y+=10;
    }
  }
  // Footer: page number (left), timestamp (right)
  let pageCount = doc.internal.getNumberOfPages();
  for(let i=1;i<=pageCount;i++){
    doc.setPage(i);
    doc.setFontSize(10);
    doc.text(`Page ${i}`, 10, pageHeight-2);
    let now = new Date();
    let ts = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
    doc.text(ts, pageWidth-50, pageHeight-2);
  }
  doc.save("Quiz_Result.pdf");
}

// Set test name in header (use document.title, fallback to filename)
(function(){
  try {
    var tn = document.title && document.title.trim() ? document.title.trim() : (location.pathname.split('/').pop() || '');
    // remove extension if present
    tn = tn.replace(/\.[^.]+$/, '');
    document.getElementById('test-name').innerText = tn ? ('- ' + tn) : '';
  } catch(e) { /* silent */ }
})();

// Load base64 logo file (lourds_logo_base64.txt) from same folder and apply it as watermark.
(function(){
  fetch('lourds_logo_base64.txt')
    .then(res => res.text())
    .then(text => {
      const b64 = text.trim();
      if(!b64) return;
      // strip any leading data: URI prefix if present
      window.logoBase64 = b64.replace(/^data:image\/[a-z]+;base64,/, '');
      const imgEl = document.getElementById('logo-watermark');
      if(imgEl){
        imgEl.src = 'data:image/png;base64,' + window.logoBase64;
        imgEl.style.display = 'block';
      }
    })
    .catch(err => { console.warn('Could not load logo base64:', err); });
})();
</script>


<script>
function sendToGoogleSheet() {
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const timeTakenSeconds = 1800 - timeLeft;
  const minutes = Math.floor(timeTakenSeconds / 60);
  const seconds = timeTakenSeconds % 60;
  const timeTaken = `${minutes}.${seconds.toString().padStart(2, '0')}`;

  const payload = {
    quizName: "Test2",
    name,
    email,
    phone,
    subject,
    attempted,
    unattempted,
    score,
    timeTaken,
    answers: selectedAnswers
  };

  console.log("Sending payload:", payload);

 fetch("https://script.google.com/macros/s/AKfycbzMafiozr8HXFsafF3VgF7N_5PdCYkD24kQCv00s5u4bOqcJ40kqrn5Wxo4BzREcSWpMA/exec", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(payload),
  mode: "no-cors"   // 👈 add this
})
.then(res => res.text())
.then(txt => {
  console.log("Sheet response:", txt);
  document.getElementById("submission-status").innerText = "✅ Your response has been recorded.";
})
.catch(err => {
  console.error("Error sending to sheet:", err);
  document.getElementById("submission-status").innerText = "⚠️ Error saving response.";
});
 
}
</script>

</body>
</html>