<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TET Quiz</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<!-- ✅ Only load jsPDF, no inline code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  em { font-family: 'Roboto', Arial, sans-serif; font-style: italic; font-weight: bold; font-size: 1.05em; color: #2a2a2a; }
  .blank { display: inline-block; border-bottom: 1px solid #333; min-width: 60px; height: 1.2em; vertical-align: middle; margin: 0 4px; }
  body, #quiz, #question-area, .option-div, .timer { font-family: 'Roboto', Arial, sans-serif; background:#f0f2f5; }
  #question-grid button { width: 30px; height: 30px; margin: 2px; color: white; font-weight: bold; border-radius: 4px; border: none; font-size: 12px; }
  .unanswered { background-color: #dc3545; }
  .answered { background-color: #28a745; }
  .marked { background-color: #6f42c1; }
  .timer { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
  .correct { color: green; font-weight: bold; }
  .wrong { color: red; font-weight: bold; }
</style>
</head>
<body>
<header class="site-header bg-white p-2 mb-3 shadow-sm d-flex justify-content-between">
  <div class="brand fw-bold">LOURDS ENGLISH ACADEMY</div>
  <div id="test-name" class="testname text-muted"></div>
</header>

<div class="container my-4">
  <div id="login" class="card p-4 shadow">
    <h3 class="mb-3">Enter Candidate Details</h3>
    <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" required>
    <input type="tel" id="phone" class="form-control mb-2" placeholder="Phone Number" required>
    <select id="subject" class="form-select mb-2" required>
      <option value="">Select Subject</option>
      <option>Tamil</option><option>English</option><option>Maths</option><option>Physics</option>
      <option>Chemistry</option><option>Botany</option><option>Zoology</option><option>History</option><option>Geography</option>
    </select>
    <button class="btn btn-primary mt-2" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<div id="quiz" class="container-fluid" style="display:none;">
  <!-- your quiz layout and questions remain unchanged -->
</div>

<div id="result" class="container my-4" style="display:none;">
  <div class="card p-4 shadow">
    <h3 class="mb-3">Quiz Result</h3>
    <p id="candidate-details"></p>
    <p>Total Questions: 30</p>
    <p>Attempted: <span id="attempted"></span></p>
    <p>Unattempted: <span id="unattempted"></span></p>
    <p>Score: <span id="score"></span> / 30</p>
    <p>Time Taken: <span id="time-taken"></span></p>
    <div id="answer-review" class="mt-3"></div>
    <button class="btn btn-info mt-3" onclick="downloadPDF()">Download Result as PDF</button>
  </div>
</div>

<script>
function getQuizName(){
  try{
    let tn=(document.title||"").trim();
    if(!tn){ tn=(location.pathname.split('/').pop()||'').replace(/\.[^.]+$/, ''); }
    return tn||'Test1';
  }catch(e){ return 'Test1'; }
}
let currentQuestion=0;
let selectedAnswers=Array(30).fill(null);
let markedQuestions=Array(30).fill(false);
let timerInterval;
let timeLeft=1800;

// === keep your full questions[] and correctAnswers[] arrays here ===
const questions = [
  {q:"Find the italicized part in the sentence that is incorrect:", stem:"In some countries <em>in Europe</em> <em>are allowed</em> <em>giving</em> children some homework only <em>at weekends</em>.", options:["1","2","3","4"]},
  {q:"Choose the correct form of the verb:", stem:"When <span class='blank'></span> this morning?", options:["did you woke up","did you wake up","have you woken up","were you woke up"]},
  {q:"Choose the correct form of the verb:", stem:"We <span class='blank'></span> volleyball yesterday.", options:["played","have played","had played","have been playing"]},
  {q:"Choose the correct word:", stem:"There is very <span class='blank'></span> petrol in the car.", options:["few","much","a little","little"]},
  {q:"Choose the correct word:", stem:"He apologized <span class='blank'></span> being late.", options:["to","for","on","of"]},
  {q:"The word ‘diurnal’ is the opposite of:", stem:"", options:["sleeps at night and is awake during the day.","hunts during the day and is awake at night.","sleeps every other night and is awake during the day.","hunts at night and sleeps during the day."]},
  {q:"Animal with small eyes…", stem:"", options:["must be diurnal.","has trouble seeing in the dark.","can see very well at night.","must be nocturnal."]},
  {q:"Owls find food using:", stem:"", options:["sight only.","sight and sound.","sight, sound and smell.","sight and smell."]},
  {q:"‘Prey’ means:", stem:"", options:["Noise an animal makes","A pet dog or cat","An animal that is hunted","An enemy"]},
  {q:"Mice sleep during the day to:", stem:"", options:["find food","keep safe","store energy","stay awake at night."]},
  {q:"Last paragraph shows:", stem:"", options:["owls hunt mice.","mice hide from owls.","both hide from predators.","owls sleep at night."]},
  {q:"Best conclusion:", stem:"", options:["The owl is nocturnal…","Mice are nocturnal…","Some animals are nocturnal…","Owls and mice sleep in day."]},
  {q:"Correct question:", stem:"The children are sitting in the garden.", options:["Where do children sit?","Where have they been sitting?","Where are they sitting?","Where are the children sitting?"]},
  {q:"Odd one out:", stem:"blood, moon, soon, mood", options:["I – blood","II – moon","III – soon","IV – mood"]},
  {q:"Odd one out:", stem:"bear, dare, fare, dear", options:["I – bear","II – dare","III – fare","IV – dear"]},
  {q:"Odd one out:", stem:"enjoyed, jumped, died, filled", options:["I – enjoyed","II – jumped","III – died","IV – filled"]},
  {q:"Incorrect italicized part:", stem:"It is a <em>well</em> idea to encourage boys to learn to cook.", options:["1","2","3","4"]},
  {q:"Synonym for assemble:", stem:"I help them to <em>assemble</em> the parts.", options:["manufacture","store","check","fit"]},
  {q:"Antonym of dangerous:", stem:"Travelling is considered very <em>dangerous</em>.", options:["harmful","peaceful","safe","exciting"]},
  {q:"Antonym of common:", stem:"This is a <em>common</em> thing.", options:["strange","funny","real","special"]},
  {q:"Language function:", stem:"Shrimathy: That remark was uncalled for. Venu: I’m sorry…", options:["apologising","wishing","blaming","forgiving"]},
  {q:"Language function:", stem:"Arun: What shall we do? Sheela: Why don’t we go…", options:["welcoming","inviting","suggesting","advising"]},
  {q:"Question tag:", stem:"Mary has answered all the questions,<span class='blank'></span>?", options:["doesn’t she","didn’t she","wasn’t she","hasn’t she"]},
  {q:"Question tag:", stem:"Hanif wasn’t listening,<span class='blank'></span>?", options:["was he","has he","did he","isn’t he"]},
  {q:"Correct question:", stem:"Hari is writing a letter.", options:["What does Hari write?","What is Hari writing?","Who is writing?","What is Hari doing?"]},
  {q:"Correct word:", stem:"We are satisfied <span class='blank'></span> progress.", options:["for","on","about","with"]},
  {q:"Verb ‘be’ form:", stem:"", options:["may","am","can","will"]},
  {q:"Passive voice:", stem:"The Blue team won the game", options:["is won","has been won","had been won","was won"]},
  {q:"Reported speech:", stem:"Renu said to me, ‘Is the movie interesting?’", options:["was interesting","has been interesting","is interesting","had been interesting"]},
  {q:"Synonym of seldom:", stem:"She <em>seldom</em> goes to conferences", options:["nearly","rarely","slightly","incredibly"]}
];

// ====== Correct Answers as Codes ======
const correctAnswers = [
 "C","B","A","D","B",
 "A","B","B","C","B",
 "B","C","C","A","D",
 "B","A","D","C","A",
 "A","C","D","A","B",
 "D","B","D","A","B"
];

function startQuiz(){ /* unchanged */ }
function buildQuestionGrid(){ /* unchanged */ }
function showQuestion(index){ /* unchanged */ }
function selectOption(val){ selectedAnswers[currentQuestion]=val; updateGridStatus(); }
function updateGridStatus(){ /* unchanged */ }
function nextQuestion(){ if(currentQuestion<29){ currentQuestion++; showQuestion(currentQuestion);} }
function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; showQuestion(currentQuestion);} }
function markForReview(){ markedQuestions[currentQuestion]=true; updateGridStatus(); }
function startTimer(){ /* unchanged */ }
function submitQuiz(){ clearInterval(timerInterval); document.getElementById('quiz').style.display='none'; document.getElementById('result').style.display='block'; showResult(); sendToGoogleSheet(); }

function showResult(){
  let {name,email,phone,subject}=window.candidateInfo;
  document.getElementById('candidate-details').innerHTML=`Name: ${name} | Email: ${email} | Phone: ${phone} | Subject: ${subject}`;
  let attempted=selectedAnswers.filter(a=>a!==null).length;
  document.getElementById('attempted').innerText=attempted;
  document.getElementById('unattempted').innerText=30-attempted;
  let score=0, html="";
  for(let i=0;i<30;i++){
    let q=questions[i], user=selectedAnswers[i], correct=correctAnswers[i];
    if(user==correct) score++;
    html+=`<p><b>Q${i+1}:</b> ${q.q}<br> Your answer: <span class="${user==correct?'correct':'wrong'}">${user?user:'Not answered'}</span> | Correct: ${correct}</p>`;
  }
  document.getElementById('score').innerText=score;
  document.getElementById('time-taken').innerText=((1800-timeLeft)/60).toFixed(2)+" minutes";
  document.getElementById('answer-review').innerHTML=html;
}

// ✅ Fixed Google Sheets sender
function sendToGoogleSheet(){
  const {name,email,phone,subject}=window.candidateInfo||{};
  const attempted=selectedAnswers.filter(a=>a!==null).length;
  const unattempted=30-attempted;
  const score=document.getElementById('score').innerText;
  const timeTaken=((1800-timeLeft)/60).toFixed(2)+" minutes";

  const answersAsCodes=selectedAnswers.map((ans,i)=>{
    if(!ans) return "";
    const opts=(questions[i]&&questions[i].options)?questions[i].options:[];
    const norm=s=>(""+s).replace(/\s+/g," ").trim();
    const normAns=norm(ans);
    let idx=-1; for(let k=0;k<opts.length;k++){ if(norm(opts[k])===normAns){ idx=k; break; } }
    return idx>=0?['A','B','C','D'][idx]:"";
  });

  const payload={quizName:getQuizName(),name,email,phone,subject,attempted,unattempted,score,timeTaken,answers:answersAsCodes};
  console.log("Sending payload:",payload);

  fetch("https://script.google.com/macros/s/AKfycbzMafiozr8HXFsafF3VgF7N_5PdCYkD24kQCv00s5u4bOqcJ40kqrn5Wxo4BzREcSWpMA/exec",{
    method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload),mode:"no-cors"})
  .then(()=>console.log("Submitted"))
  .catch(err=>console.error("Error sending to sheet:",err));
}

// ✅ PDF with correct time
function downloadPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF({format:'a4',unit:'mm'});
  const pageWidth=doc.internal.pageSize.getWidth();
  doc.setFont("helvetica","bold");
  doc.setFontSize(16);
  doc.text("LOURDS ENGLISH ACADEMY",pageWidth/2,16,{align:"center"});
  doc.setFontSize(12);
  doc.text(document.title||"Test Name",pageWidth/2,22,{align:"center"});
  let y=30;
  doc.setFontSize(11);
  doc.text("Total Questions: 30",10,y); y+=6;
  doc.text("Attempted: "+selectedAnswers.filter(a=>a!==null).length,10,y); y+=6;
  doc.text("Unattempted: "+(30-selectedAnswers.filter(a=>a!==null).length),10,y); y+=6;
  doc.text("Score: "+document.getElementById('score').innerText+" / 30",10,y); y+=6;
  doc.text("Time Taken: "+((1800-timeLeft)/60).toFixed(2)+" minutes",10,y);
  doc.save("Quiz_Result.pdf");
}
</script>
</body>
</html>
