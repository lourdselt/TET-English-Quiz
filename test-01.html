<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>test-01</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
function getQuizName(){
  try{
    let tn = (document.title || "").trim();
    if(!tn){ tn = (location.pathname.split('/').pop() || '').replace(/\.[^.]+$/, ''); }
    tn = tn || 'test-01';
    // Return the title/filename as the sheet tab name (no legacy mapping)
    return tn;
  }catch(e){ return 'Test1'; }
}
function sendToGoogleSheet() {
  if(!window.candidateInfo){ console.warn('No candidateInfo; skipping sheet send'); return; }
  const { name, email, phone, subject } = window.candidateInfo;
  const attempted = selectedAnswers.filter(a => a !== null).length;
  const unattempted = 30 - attempted;
  const score = document.getElementById('score').innerText;
  const elapsedSec = 1800 - timeLeft;
  const timeReadable = `${String(Math.floor(elapsedSec/60)).padStart(2,'0')}:${String(elapsedSec%60).padStart(2,'0')}`;
  const timeTaken = timeReadable;
  const answers = selectedAnswers.map((idx) => idx===null?"":['A','B','C','D'][idx]);
  const answersCsv = answers.join(',');
  const answerTexts = selectedAnswers.map((idx,i)=> (idx!==null && questions[i] && questions[i].options[idx])? questions[i].options[idx] : "");
  console.log('Selected indices:', JSON.stringify(selectedAnswers));
  console.log('Answer codes to send:', JSON.stringify(answers));
  const payload = { quizName: getQuizName(), name, email, phone, subject, attempted, unattempted, score, timeTaken, timeTakenReadable: timeReadable, answers, answerCodes: answers, answersCsv, answerCodesCsv: answersCsv, answerTexts };
  fetch("https://script.google.com/macros/s/AKfycbyeVJR0A_CvLsIXQvx5IN7zcPK66T0Uy3B09kasOSgXnxGp8LaepjmIt-IXwA3d0rHiUw/exec", {
    method: "POST", body: JSON.stringify(payload), mode: "no-cors"
  }).then(() => console.log("Sheet submission sent")).catch(err => console.error("Error sending to sheet:", err));
}
</script>
<style>
  em { font-family: 'Roboto', Arial, sans-serif; font-style: italic; font-weight: bold; font-size: 1.05em; color: #2a2a2a; }
  .blank { display: inline-block; border-bottom: 1px solid #333; min-width: 60px; height: 1.2em; vertical-align: middle; margin: 0 4px; }
  body, #quiz, #question-area, .option-div, .timer { font-family: 'Roboto', Arial, sans-serif; background:#f0f2f5; }
  #question-grid button { width: 30px; height: 30px; margin: 2px; color: white; font-weight: bold; border-radius: 4px; border: none; font-size: 12px; }
  .unanswered { background-color: #dc3545; }
  .answered { background-color: #28a745; }
  .marked { background-color: #6f42c1; }
  .passage-container { max-height: 220px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ced4da; margin-bottom: 15px; }
  .timer { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
  .correct { color: green; font-weight: bold; }
  .wrong { color: red; font-weight: bold; }
  .progress { height: 20px; margin-bottom: 15px; }
  .option-div { margin: 0 0 0 8px; padding: 0; line-height: 1.2; display: flex; align-items: center; }
  .option-div label { display: inline; margin-left: 6px; }
  .site-header { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: #fff; border-bottom: 1px solid #e6e6e6; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; z-index: 1100; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
  .site-header .brand { font-weight: 700; font-size: 1.05rem; color: #222; }
  .site-header .testname { font-size: 0.95rem; color: #555; }
  body { padding-top: 72px; }
  /* Result card watermark sizing and placement */
  #result .card { position: relative; overflow: hidden; }
  .logo-watermark { position: absolute; right: 12px; top: 12px; width: 80px; height: auto; opacity: 0.12; pointer-events: none; filter: grayscale(100%); }
</style>
</head>
<body>
<header class="site-header" role="banner" aria-label="Site header">
  <div class="brand">LOURDS ENGLISH ACADEMY</div>
  <div id="test-name" class="testname"></div>
</header>

<div class="container my-4">
  <div id="login" class="card p-4 shadow">
    <h3 class="mb-3">Enter Candidate Details</h3>
    <input type="text" id="name" class="form-control mb-2" placeholder="Name" required>
    <input type="email" id="email" class="form-control mb-2" placeholder="Email" required>
    <input type="tel" id="phone" class="form-control mb-2" placeholder="Phone Number" required>
    <select id="subject" class="form-select mb-2" required onchange="onSubjectChange()">
      <option value="">Select Subject</option>
      <option>Tamil</option><option>English</option><option>Maths</option><option>Physics</option>
      <option>Chemistry</option><option>Botony</option><option>Zoology</option><option>History</option><option>Geography</option>
      <option value="Other">Other</option>
    </select>
    <input type="text" id="subject-other" class="form-control mb-2" placeholder="Enter subject (if Other)" style="display:none;" />
    <button class="btn btn-primary mt-2" onclick="startQuiz()">Start Quiz</button>
  </div>
</div>

<div id="quiz" class="container-fluid" style="display:none;">
  <div class="row">
    <div class="col-md-2 bg-white p-3 shadow">
      <h5 class="text-center mb-3">Questions</h5>
      <div id="question-grid" class="d-flex flex-wrap justify-content-center"></div>
      <div class="mt-3 text-center">
        <span class="fw-bold">Green:</span> Answered<br>
        <span class="fw-bold">Red:</span> Unanswered<br>
        <span class="fw-bold">Purple:</span> Marked
      </div>
    </div>
    <div class="col-md-10 p-4">
      <div class="timer text-end" id="timer">Time Remaining: 30:00</div>
      <div class="progress mb-3">
        <div id="timerBar" class="progress-bar bg-success" role="progressbar" style="width: 100%"></div>
      </div>
      <div id="passage-section" class="passage-container" style="display:none;">
        <h5>Read the passage carefully:</h5>
        <p>Most human beings are awake during the day and sleep at night. Owls live the opposite way. Owls are nocturnal. This means that they sleep all day and stay awake at night. Because owls are nocturnal, this means they must eat at night. But finding food in the dark is difficult. To help them, they have special eyes and ears.</p>
        <p>Owls have very large eyes. These eyes absorb more light than normal. Since there is little light during the night, it is helpful to be able to absorb more of it. This helps owls find food in the dark.</p>
        <p>Owls also have very good hearing. Even when owls are in the trees, they can hear small animals moving in the grass below. This helps owls catch their prey even when it is very dark.</p>
        <p>Like owls, mice are also nocturnal animals. Mice have an excellent sense of smell. This helps them find food in the dark.</p>
        <p>Being nocturnal helps mice to hide from many different animals that want to eat them. Most of the birds, snakes and lizards that like to eat mice sleep at night — except, of course, owls!</p>
      </div>
      <div class="card p-3 mb-3 shadow" id="question-area"></div>
      <div class="mb-4">
        <button class="btn btn-secondary me-2" onclick="prevQuestion()">Previous</button>
        <button class="btn btn-secondary me-2" onclick="nextQuestion()">Next</button>
        <button class="btn btn-warning me-2" onclick="markForReview()">Mark for Review</button>
        <button class="btn btn-success" onclick="submitQuiz()">Submit Test</button>
      </div>
    </div>
  </div>
</div>

<div id="result" class="container my-4" style="display:none;">
  <div class="card p-4 shadow">
    <img id="logo-watermark" class="logo-watermark" alt="watermark logo" style="display:none;">
    <h3 class="mb-3">Quiz Result</h3>
    <p id="candidate-details"></p>
    <p>Total Questions: 30</p>
    <p>Attempted: <span id="attempted"></span></p>
    <p>Unattempted: <span id="unattempted"></span></p>
    <p>Score: <span id="score"></span> / 30</p>
    <p>Time Taken: <span id="time-taken"></span></p>
    <div id="answer-review" class="mt-3"></div>
    <button class="btn btn-info mt-3" onclick="downloadPDF()">Download Result as PDF</button>
  </div>
</div>

<script>
let currentQuestion = 0;
// Store selected answers as option INDEX (0-3) to avoid HTML escaping issues
let selectedAnswers = Array(30).fill(null);
let markedQuestions = Array(30).fill(false);
let timerInterval;
let timeLeft = 1800;

const questions = [
  {q:"Find the italicized part in the sentence that is incorrect:", stem:"In some countries <b><em>in Europe</em> (1)</b> <b><em>are allowed</em> (2)</b> <b><em>giving</em> (3)</b> children some homework only <b><em>at weekends</em> (4)</b>.", options:["1","2","3","4"], parts:["in Europe","are allowed","giving","at weekends"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"When <span class='blank'></span> this morning?", options:["did you woke up","did you wake up","have you woken up","were you woke up"]},
  {q:"Choose the correct form of the verb to complete the sentence:", stem:"We <span class='blank'></span> volleyball yesterday.", options:["played","have played","had played","have been playing"]},
  {q:"Choose the correct word to complete the sentence:", stem:"There is very <span class='blank'></span> petrol in the car. I’ll buy some when I go out.", options:["few","much","a little","little"]},
  {q:"Choose the correct word to complete the sentence:", stem:"He apologized <span class='blank'></span> being late.", options:["to","for","on","of"]},
  {q:"The word ‘diurnal’ is the opposite of the word nocturnal. Using information in the passage we can understand that an animal that is diurnal", stem:"", options:["sleeps at night and is awake during the day.","hunts during the day and is awake at night.","sleeps every other night and is awake during the day.","hunts at night and sleeps during the day."]},
  {q:"Based on information in paragraph 2, it can be understood that an animal with small eyes", stem:"", options:["must be diurnal.","has trouble seeing in the dark.","can see very well at night.","must be nocturnal."]},
  {q:"According to the passage, owls can find food in the dark using their sense of", stem:"", options:["sight only.","sight and sound.","sight, sound and smell.","sight and smell."]},
  {q:"In paragraph 3 the author writes: ‘This helps owls catch their prey when it is very dark.’ What is prey?", stem:"", options:["A noise that an animal makes during the night.","A small animal such as a pet dog or cat.","An animal that is hunted by other animals.","An enemy."]},
  {q:"According to the passage, mice sleep during the day in order to", stem:"", options:["find food that other animals cannot.","keep themselves safe.","store energy for night time activities.","stay awake at night."]},
  {q:"Using information in the last paragraph, it can be understood that", stem:"", options:["owls hunt mice.","mice can hide from owls.","mice and owls both hide from birds, snakes and lizards.","owls sleep at night."]},
  {q:"Which of the following conclusions would work best at the end of this passage?", stem:"", options:["The owl is a nocturnal animal. This means it is active at night. The owl’s excellent sense of sight and sound enables it to find food in the dark.","Mice are nocturnal animals. This means they are active at night. Similar to the owl, mice use their excellent sense of smell to find food in the dark.","Some animals are nocturnal. This means they are active at night. The owl and the mouse are good examples of animals that use their senses to find food in the dark.","The owl and the mouse sleep during the day and stay awake at night."]},
  {q:"Choose the right question to get the italicized part as the answer:", stem:"The children are sitting in the garden.", options:["Where do children sit?","Where have the children been sitting?","Where are the children sitting?","Where are they sitting?"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. blood II. moon III. soon IV. mood", options:["I – blood","II – moon","III – soon","IV – mood"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. bear II. dare III. fare IV. dear", options:["I – bear","II – dare","III – fare","IV – dear"]},
  {q:"Find the word that is pronounced differently from the others:", stem:"I. enjoyed II. jumped III. died IV. filled", options:["I – enjoyed","II – jumped","III – died","IV – filled"]},
  {q:"Find the italicized part in the sentence that is incorrect:", stem:"It is a <b><em>well</em> (1)</b> idea <b><em>to encourage</em> (2)</b> boys <b><em>to learn</em> (3)</b> <b><em>to cook</em> (4)</b>.", options:["1","2","3","4"]},
  {q:"Choose the word which has almost the same meaning as the italicized one:", stem:"I help them to <em>assemble</em> the different parts.", options:["manufacture","store","check","fit"]},
  {q:"Choose the correct antonym for the italicized word:", stem:"Travelling is considered very <em>dangerous</em>.", options:["harmful","peaceful","safe","exciting"]},
  {q:"Choose the correct antonym for the italicized word:", stem:"This is a <em>common</em> thing.", options:["strange","funny","real","special"]},
  {q:"Read the short conversation and identify the language function:", stem:"Shrimathy: That remark was uncalled for.\nVenu: <em>I’m sorry, I shouldn’t have said it.</em>", options:["apologising","wishing","blaming","forgiving"]},
  {q:"Read the short conversation and identify the language function:", stem:"Arun: What shall we do this weekend?\nSheela: <em>Why don’t we go on a picnic?</em>", options:["welcoming","inviting","suggesting","advising"]},
  {q:"Choose the correct question tag:", stem:"Mary has answered all the questions,<span class='blank'></span>?", options:["doesn’t she","didn’t she","wasn’t she","hasn’t she"]},
  {q:"Choose the correct question tag:", stem:"Hanif wasn’t listening <span class='blank'></span>?", options:["was he","has he","did he","isn’t he"]},
  {q:"Choose the right question to get the italicized part as the answer:", stem:"Hari is writing a letter.", options:["What does Hari write?","What is Hari writing?","Who is writing a letter?","What is Hari doing?"]},
  {q:"Choose the correct word to complete the sentence:", stem:"We are satisfied <span class='blank'></span> our son’s progress this term.", options:["for","on","about","with"]},
  {q:"Which of the following is a form of the verb ‘be’?", stem:"", options:["may","am","can","will"]},
  {q:"The passive form of the sentence “The Blue team won the game” is:", stem:"", options:["The game is won by the Blue team.","The game has been won by the Blue team.","The game had been won by the Blue team.","The game was won by the Blue team."]},
  {q:"The reported form of the question “Renu said to me, ‘Is the movie interesting?’” is:", stem:"", options:["Renu asked me if the movie was interesting.","Renu asked me if the movie has been interesting.","Renu asked me if the movie is interesting.","Renu asked me if the movie had been interesting."]},
  {q:"Choose the word which has almost the same meaning as the italicized one:", stem:"She <em>seldom</em> goes to conferences", options:["nearly","rarely","slightly","incredibly"]}
];
const correctAnswers = [
  "3",
  "did you wake up",
  "played",
  "little",
  "for",
  "sleeps at night and is awake during the day.",
  "can see very well at night.",
  "sight and sound.",
  "An animal that is hunted by other animals.",
  "stay awake at night.",
  "mice can hide from owls.",
  "Some animals are nocturnal. This means they are active at night. The owl and the mouse are good examples of animals that use their senses to find food in the dark.",
  "Where are the children sitting?",
  "I – blood",
  "IV – dear",
  "II – jumped",
  "1",
  "fit",
  "safe",
  "strange",
  "apologising",
  "suggesting",
  "hasn’t she",
  "was he",
  "What is Hari writing?",
  "with",
  "am",
  "The game was won by the Blue team.",
  "Renu asked me if the movie was interesting.",
  "rarely"
];

function startQuiz(){
  let name = document.getElementById('name').value.trim();
  let email = document.getElementById('email').value.trim();
  let phone = document.getElementById('phone').value.trim();
  let subject = document.getElementById('subject').value;
  if (subject === 'Other') {
    const otherVal = (document.getElementById('subject-other').value || '').trim();
    if (!otherVal) { alert('Please type your subject'); return; }
    subject = otherVal;
  }
  if(!name || !email || !phone || !subject){ alert("Please fill all details"); return;}
  window.candidateInfo = {name,email,phone,subject};
  document.getElementById('login').style.display='none';
  document.getElementById('quiz').style.display='block';
  buildQuestionGrid();
  showQuestion(currentQuestion);
  startTimer();
}

function onSubjectChange(){
  const sel = document.getElementById('subject');
  const other = document.getElementById('subject-other');
  if (!sel || !other) return;
  if (sel.value === 'Other') { other.style.display = ''; other.focus(); }
  else { other.style.display = 'none'; other.value = ''; }
}

function buildQuestionGrid(){
  let grid = document.getElementById('question-grid');
  for(let i=0;i<30;i++){
    let btn = document.createElement('button');
    btn.id = 'qbtn'+i;
    btn.innerText = i+1;
    btn.className = 'unanswered';
    btn.onclick = ()=>{currentQuestion=i; showQuestion(i);}
    grid.appendChild(btn);
  }
}

function showQuestion(index){
  if (index >= 5 && index <= 11) {
    document.getElementById('passage-section').style.display = 'block';
  } else {
    document.getElementById('passage-section').style.display = 'none';
  }
  let q = questions[index];
  let html = `<div><b>Q${index+1}. ${q.q}</b></div>`;
  html += `<div>${q.stem || ''}</div>`;
  const optionCodes = ['a)', 'b)', 'c)', 'd)'];
  for(let i=0;i<q.options.length;i++){
    const checked = selectedAnswers[index] === i ? 'checked' : '';
    html += `<div class="option-div"><input type="radio" name="option" id="opt${i}" value="${i}" ${checked} onclick="selectOptionIndex(${i})"> <label for="opt${i}">${optionCodes[i]} ${q.options[i]}</label></div>`;
  }
  document.getElementById('question-area').innerHTML = html;
}

function selectOptionIndex(idx){ selectedAnswers[currentQuestion] = idx; updateGridStatus(); }
function updateGridStatus(){
  for(let i=0;i<30;i++){
    let btn = document.getElementById('qbtn'+i);
    if(markedQuestions[i]) btn.className='marked';
    else if(selectedAnswers[i] !== null) btn.className='answered';
    else btn.className='unanswered';
  }
}
function nextQuestion(){ if(currentQuestion<29){ currentQuestion++; showQuestion(currentQuestion);} }
function prevQuestion(){ if(currentQuestion>0){ currentQuestion--; showQuestion(currentQuestion);} }
function markForReview(){ markedQuestions[currentQuestion]=true; updateGridStatus(); }
function startTimer(){ timerInterval = setInterval(()=>{ timeLeft--; let min=Math.floor(timeLeft/60); let sec=timeLeft%60; document.getElementById('timer').innerText=`Time Remaining: ${min}:${sec<10?'0'+sec:sec}`; document.getElementById('timerBar').style.width=(timeLeft/1800*100)+'%'; if(timeLeft<=0){ clearInterval(timerInterval); submitQuiz();}},1000); }
function submitQuiz(){ clearInterval(timerInterval); document.getElementById('quiz').style.display='none'; document.getElementById('result').style.display='block'; showResult(); sendToGoogleSheet(); }

function showResult(){
  let {name,email,phone,subject} = window.candidateInfo;
  document.getElementById('candidate-details').innerHTML=`Name: ${name} | Email: ${email} | Phone: ${phone} | Subject: ${subject}`;
  let attempted=selectedAnswers.filter(a=>a!==null).length;
  document.getElementById('attempted').innerText=attempted;
  document.getElementById('unattempted').innerText=30-attempted;
  let score=0;
  let html="";
  for(let i=0;i<30;i++){
    let q=questions[i];
    let userIdx=selectedAnswers[i];
    const norm = (s)=> (""+s).replace(/\s+/g,' ').trim();
    let correctIdx = Array.isArray(q.options) ? q.options.findIndex(o => norm(o)===norm(correctAnswers[i])) : -1;
    if(userIdx!==null && userIdx===correctIdx) score++;
    const userText = (userIdx!==null && q.options[userIdx]) ? q.options[userIdx] : 'Not answered';
    const correctText = (correctIdx>=0 && q.options[correctIdx]) ? q.options[correctIdx] : correctAnswers[i];
    const cls = (userIdx!==null && userIdx===correctIdx) ? 'correct' : 'wrong';
    html+=`<p><b>Q${i+1}:</b> ${q.stem}<br> Your answer: <span class="${cls}">${userText}</span> | Correct: ${correctText}</p>`;
  }
  document.getElementById('score').innerText=score;
  const elapsedSec = 1800 - timeLeft;
  const mm = Math.floor(elapsedSec/60);
  const ss = elapsedSec % 60;
  const timeReadable = `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
  document.getElementById('time-taken').innerText = timeReadable;
  document.getElementById('answer-review').innerHTML=html;
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({format: 'a4', unit: 'mm'});
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  // Table geometry to keep summary perfectly aligned with table
  const tableMarginLeft = 10;
  const tableColumnWidths = [12, 85, 85]; // Q#, Your Answer, Correct Answer
  const tableRightX = tableMarginLeft + tableColumnWidths.reduce((a,b)=>a+b,0);
  // Helper: centered big watermark on a page
  const drawCenteredWatermark = () => {
    try {
      // Use black variant (very low opacity) so it doesn't disturb text
      const b64 = window.logoBlackBase64 || window.logoGreyBase64 || window.logoBase64;
      if (!b64) return;
      const imgEl = document.getElementById('logo-watermark');
      const iw = (imgEl && imgEl.naturalWidth) ? imgEl.naturalWidth : 1000;
      const ih = (imgEl && imgEl.naturalHeight) ? imgEl.naturalHeight : 1000;
      const aspect = iw/ih;
      const maxW = pageWidth * 0.6;
      const maxH = pageHeight * 0.6;
      let w = maxW; let h = w/aspect;
      if (h > maxH) { h = maxH; w = h*aspect; }
      const x = (pageWidth - w)/2;
      const y = (pageHeight - h)/2;
      if (doc.GState) { doc.setGState(new doc.GState({ opacity: 0.06 })); }
      doc.addImage('data:image/png;base64,' + b64, 'PNG', x, y, w, h);
      if (doc.GState) { doc.setGState(new doc.GState({ opacity: 1 })); }
    } catch (_) {}
  };
  // Header with logo and title
  const academy = "LOURDS ENGLISH ACADEMY";
  try {
    const headerB64 = window.logoBlackBase64 || window.logoGreyBase64 || window.logoBase64;
    if (headerB64) { doc.addImage('data:image/png;base64,' + headerB64, 'PNG', 10, 8, 18, 18); }
  } catch (_) {}
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text(academy, pageWidth/2, 16, {align: "center"});
  doc.setFontSize(12);
  doc.text(document.title || "Test Name", pageWidth/2, 22, {align: "center"});

  // Candidate details box
  doc.setLineWidth(0.2);
  // Draw divider line exactly the width of the table
  doc.line(tableMarginLeft, 26, tableRightX, 26);
  doc.setFontSize(10);
  const metaY = 30;
  const attempted = selectedAnswers.filter(a=>a!==null).length;
  const unattempted = 30 - attempted;
  const scoreText = document.getElementById('score').innerText + ' / 30';
  const elapsedSecPDF = 1800 - timeLeft;
  const timeReadablePDF = `${String(Math.floor(elapsedSecPDF/60)).padStart(2,'0')}:${String(elapsedSecPDF%60).padStart(2,'0')}`;
  const timeText = `${timeReadablePDF}`;
  const cd = window.candidateInfo || {name:'',email:'',phone:'',subject:''};
  const leftX = tableMarginLeft, rightX = tableRightX;
  // Left block
  doc.text(`Name: ${cd.name || ''}`, leftX, metaY);
  doc.text(`Email: ${cd.email || ''}`, leftX, metaY+6);
  doc.text(`Phone: ${cd.phone || ''}`, leftX, metaY+12);
  doc.text(`Subject: ${cd.subject || ''}`, leftX, metaY+18);
  // Right block aligned to right edge of table
  doc.text(`Attempted: ${attempted}`, rightX, metaY, { align: 'right' });
  doc.text(`Unattempted: ${unattempted}`, rightX, metaY+6, { align: 'right' });
  // Score in blue
  doc.setTextColor(0, 102, 204);
  doc.text(`Score: ${scoreText}`, rightX, metaY+12, { align: 'right' });
  doc.setTextColor(0, 0, 0);
  doc.text(`Time: ${timeText}`, rightX, metaY+18, { align: 'right' });

  // Build table rows
  const startY = metaY + 26;
  const norm = (s)=> (""+s).replace(/\s+/g,' ').trim();
  const rows = [];
  const ansColors = []; // text color for 'Your Answer' cell per row
  for (let i = 0; i < 30; i++) {
    const q = questions[i];
    const userIdx = selectedAnswers[i];
    const correctIdx = Array.isArray(q.options) ? q.options.findIndex(o => norm(o) === norm(correctAnswers[i])) : -1;
    const code = ['A','B','C','D'];
    const youCode = (userIdx!==null && userIdx>=0) ? code[userIdx] : '';
    const corrCode = (correctIdx>=0) ? code[correctIdx] : '';
    const youText = (userIdx!==null && q.options[userIdx]) ? q.options[userIdx] : '';
    const corrText = (correctIdx>=0 && q.options[correctIdx]) ? q.options[correctIdx] : correctAnswers[i];
    // Decide color: grey for not answered, green for correct, red for wrong
    let color = [130,130,130];
    if (userIdx !== null) {
      color = (userIdx === correctIdx) ? [0,128,0] : [200,0,0];
    }
    ansColors.push(color);
    rows.push([
      (i+1).toString(),
      youCode ? `${youCode}) ${youText}` : 'Not answered',
      corrCode ? `${corrCode}) ${corrText}` : corrText
    ]);
  }

  // Use autoTable for a clean table layout
  if (doc.autoTable) {
    doc.autoTable({
      head: [['Q#', 'Your Answer', 'Correct Answer']],
      body: rows,
      startY: startY,
      margin: { left: tableMarginLeft, right: 10 },
      theme: 'grid',
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [33, 37, 41], halign: 'center', valign: 'middle', fontStyle: 'bold', textColor: 255 },
      columnStyles: {
        0: { halign: 'center', cellWidth: tableColumnWidths[0] },
        1: { cellWidth: tableColumnWidths[1] },
        2: { cellWidth: tableColumnWidths[2] }
      },
      didParseCell: function(data) {
        if (data.section === 'body' && data.column.index === 1) {
          const idx = data.row.index;
          const col = ansColors[idx] || [0,0,0];
          data.cell.styles.textColor = col;
        }
      },
      didDrawPage: function(data) {
        // Watermark for every page, draw after content with very low opacity
        if (data.pageNumber && data.pageNumber >= 1) {
          drawCenteredWatermark();
        }
        // Footer: timestamp left, page numbers right
        const totalPages = doc.internal.getNumberOfPages();
        const pageStr = 'Page ' + totalPages;
        const now = new Date();
        const ts = `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        doc.setFontSize(9);
        doc.text(ts, 10, pageHeight - 8);
        doc.text(pageStr, pageWidth - 20, pageHeight - 8);
      }
    });
  } else {
    // Fallback simple list if autotable isn't loaded
    let y = startY;
    for (const r of rows) {
      const line = `${r[0]}. Your: ${r[1]} | Correct: ${r[2]}`;
      const lines = doc.splitTextToSize(line, pageWidth - 20);
      if (y + lines.length*6 > pageHeight - 14) { doc.addPage(); y = 14; }
      doc.text(lines, 10, y);
      y += lines.length*6;
    }
  }

  doc.save("Quiz_Result.pdf");
}

// Set test name in header
(function(){ try{ var tn=(document.title||'').trim() || (location.pathname.split('/').pop()||''); tn=tn.replace(/\.[^.]+$/,''); var el=document.getElementById('test-name'); if(el) el.innerText = tn?('- '+tn):''; }catch(e){} })();

// Load watermark image and prepare grayscale/black variants for PDF and on-page rendering
;(function(){
  fetch('lourds_logo_base64.txt').then(r=>r.text()).then(t=>{
    const raw=t.trim(); if(!raw) return;
    window.logoBase64 = raw.replace(/^data:image\/[a-z]+;base64,/,'');
    const img=new Image();
    img.onload=function(){
      try{
        const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
        const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,w,h);
        const src=ctx.getImageData(0,0,w,h); const data=src.data;
        const grayArr=new Uint8ClampedArray(data); const blackArr=new Uint8ClampedArray(data);
        for(let i=0;i<data.length;i+=4){
          const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3];
          const y=Math.round(0.299*r+0.587*g+0.114*b);
          // grayscale for watermark
          grayArr[i]=y; grayArr[i+1]=y; grayArr[i+2]=y; grayArr[i+3]=a;
          // darkened grayscale for header icon
          const yDark=Math.max(0,Math.min(255,Math.round(y*0.25)));
          blackArr[i]=yDark; blackArr[i+1]=yDark; blackArr[i+2]=yDark; blackArr[i+3]=a;
        }
        const toB64=(arr)=>{ const c=document.createElement('canvas'); c.width=w; c.height=h; const cx=c.getContext('2d'); const id=cx.createImageData(w,h); id.data.set(arr); cx.putImageData(id,0,0); return c.toDataURL('image/png').replace(/^data:image\/png;base64,/, ''); };
        window.logoGreyBase64=toB64(grayArr);
        window.logoBlackBase64=toB64(blackArr);
      }catch(e){}
      const el=document.getElementById('logo-watermark');
      if(el){ el.src='data:image/png;base64,'+(window.logoGreyBase64||window.logoBase64); el.style.display='block'; }
    };
    img.src='data:image/png;base64,'+window.logoBase64;
  }).catch(()=>{});
})();

// Expose functions to window for inline handlers
try {
  window.startQuiz = startQuiz;
  window.prevQuestion = prevQuestion;
  window.nextQuestion = nextQuestion;
  window.markForReview = markForReview;
  window.submitQuiz = submitQuiz;
  window.selectOptionIndex = selectOptionIndex;
  window.downloadPDF = downloadPDF;
  window.onSubjectChange = onSubjectChange;
} catch(_){}
</script>
</body>
</html>
